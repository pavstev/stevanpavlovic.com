---
import { Icon } from 'astro-icon/components';

import { cn } from '../../lib/cn';
import Button from './button.astro';
import Stack from './stack.astro';

export interface DropdownOption {
  href?: string;
  label: string;
  value: string;
}

interface Props {
  align?: 'center' | 'left' | 'right';
  class?: string;
  id: string;
  label: string;
  options: DropdownOption[];
  selectedValue?: string;
  selectedValues?: string[];
  size?: 'default' | 'sm';
  variant?: 'default' | 'ghost' | 'outline';
}

const {
  align = 'left',
  class: className,
  id,
  label,
  options,
  selectedValue,
  selectedValues,
  size = 'sm',
  variant = 'ghost',
} = Astro.props;

const isMultiSelect = selectedValues !== undefined;
const isSelected = (value: string) => {
  if (isMultiSelect) {
    return selectedValues?.includes(value) ?? false;
  }
  return selectedValue === value;
};

const selectedOption = !isMultiSelect ? options.find((opt) => opt.value === selectedValue) : undefined;
const displayLabel = selectedOption ? selectedOption.label : label;

const alignClasses = {
  center: 'left-1/2 -translate-x-1/2',
  left: 'left-0',
  right: 'right-0',
};
---

<div
  class:list={cn('dropdown relative inline-block', className)}
  data-dropdown={id}
>
  <Button
    aria-controls={`${id}-menu`}
    aria-expanded="false"
    aria-haspopup="listbox"
    aria-label={displayLabel}
    class="dropdown-trigger whitespace-nowrap"
    data-dropdown-trigger={id}
    id={`${id}-trigger`}
    size={size}
    variant={variant}
  >
    <span>{displayLabel}</span>
    <Icon class="dropdown-icon size-4 transition-transform duration-200" name="mdi:chevron-down" />
  </Button>

  <Stack
    align="stretch"
    aria-label={`${label} options`}
    aria-orientation="vertical"
    as="ul"
    class:list={cn(
      'dropdown-menu invisible absolute z-50 mt-1 min-w-[160px] rounded-md border border-border bg-popover p-1 opacity-0 shadow-lg transition-all duration-200',
      alignClasses[align]
    )}
    data-dropdown-menu={id}
    direction="col"
    gap={1}
    id={`${id}-menu`}
    role="listbox"
    tabindex="-1"
  >
    {
      options.map((option, index) => (
        <li role="presentation">
          {option.href ? (
            <a
              aria-selected={isSelected(option.value)}
              class:list={cn(
                'dropdown-item flex w-full items-center justify-between rounded-sm px-3 py-2 text-sm transition-colors',
                'hover:bg-accent hover:text-accent-foreground',
                'focus:bg-accent focus:text-accent-foreground focus:outline-none',
                'focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2',
                isSelected(option.value) && 'bg-accent/50 font-medium text-accent-foreground'
              )}
              href={option.href}
              id={`${id}-option-${index}`}
              role="option"
            >
              <span>{option.label}</span>
              {isSelected(option.value) && (
                <Icon class="size-4" name="mdi:check" />
              )}
            </a>
          ) : (
            <button
              aria-selected={isSelected(option.value)}
              class:list={cn(
                'dropdown-item flex w-full items-center justify-between rounded-sm px-3 py-2 text-left text-sm transition-colors',
                'hover:bg-accent hover:text-accent-foreground',
                'focus:bg-accent focus:text-accent-foreground focus:outline-none',
                'focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2',
                isSelected(option.value) && 'bg-accent/50 font-medium text-accent-foreground'
              )}
              data-value={option.value}
              id={`${id}-option-${index}`}
              role="option"
              type="button"
            >
              <span>{option.label}</span>
              {isSelected(option.value) && (
                <Icon class="size-4" name="mdi:check" />
              )}
            </button>
          )}
        </li>
      ))
    }
  </Stack>
</div>

<script>
  import { initDropdowns } from '../../lib/dropdown';

  initDropdowns();
  document.addEventListener('astro:page-load', initDropdowns);
</script>
