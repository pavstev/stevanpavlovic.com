---
import { Icon } from 'astro-icon/components';

import { cn } from '../../lib/cn';
import Button from './button.astro';
import Stack from './stack.astro';

export interface DropdownOption {
  href?: string;
  label: string;
  value: string;
}

interface Props {
  align?: 'center' | 'left' | 'right';
  class?: string;
  id: string;
  label: string;
  options: DropdownOption[];
  selectedValue?: string;
  selectedValues?: string[];
  size?: 'default' | 'sm';
  variant?: 'default' | 'ghost' | 'outline';
}

const {
  align = 'left',
  class: className,
  id,
  label,
  options,
  selectedValue,
  selectedValues,
  size = 'sm',
  variant = 'ghost',
} = Astro.props;

const isMultiSelect = selectedValues !== undefined;
const isSelected = (value: string) => {
  if (isMultiSelect) {
    return selectedValues?.includes(value) ?? false;
  }
  return selectedValue === value;
};

const selectedOption = !isMultiSelect ? options.find((opt) => opt.value === selectedValue) : undefined;
const displayLabel = selectedOption ? selectedOption.label : label;

const alignClasses = {
  center: 'left-1/2 -translate-x-1/2',
  left: 'left-0',
  right: 'right-0',
};
---

<div
  class:list={cn('dropdown relative inline-block', className)}
  data-dropdown={id}
>
  <Button
    aria-controls={`${id}-menu`}
    aria-expanded="false"
    aria-haspopup="listbox"
    aria-label={displayLabel}
    class="dropdown-trigger whitespace-nowrap"
    data-dropdown-trigger={id}
    id={`${id}-trigger`}
    size={size}
    variant={variant}
  >
    <span>{displayLabel}</span>
    <Icon class="dropdown-icon size-4 transition-transform duration-200" name="mdi:chevron-down" />
  </Button>

  <Stack
    align="stretch"
    aria-label={`${label} options`}
    aria-orientation="vertical"
    as="ul"
    class:list={cn(
      'dropdown-menu invisible absolute z-50 mt-1 min-w-[160px] rounded-md border border-border bg-popover p-1 opacity-0 shadow-lg transition-all duration-200',
      alignClasses[align]
    )}
    data-dropdown-menu={id}
    direction="col"
    gap={1}
    id={`${id}-menu`}
    role="listbox"
    tabindex="-1"
  >
    {
      options.map((option, index) => (
        <li role="presentation">
          {option.href ? (
            <a
              aria-selected={isSelected(option.value)}
              class:list={cn(
                'dropdown-item flex w-full items-center justify-between rounded-sm px-3 py-2 text-sm transition-colors',
                'hover:bg-accent hover:text-accent-foreground',
                'focus:bg-accent focus:text-accent-foreground focus:outline-none',
                'focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2',
                isSelected(option.value) && 'bg-accent/50 font-medium text-accent-foreground'
              )}
              href={option.href}
              id={`${id}-option-${index}`}
              role="option"
            >
              <span>{option.label}</span>
              {isSelected(option.value) && (
                <Icon class="size-4" name="mdi:check" />
              )}
            </a>
          ) : (
            <button
              aria-selected={isSelected(option.value)}
              class:list={cn(
                'dropdown-item flex w-full items-center justify-between rounded-sm px-3 py-2 text-left text-sm transition-colors',
                'hover:bg-accent hover:text-accent-foreground',
                'focus:bg-accent focus:text-accent-foreground focus:outline-none',
                'focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2',
                isSelected(option.value) && 'bg-accent/50 font-medium text-accent-foreground'
              )}
              data-value={option.value}
              id={`${id}-option-${index}`}
              role="option"
              type="button"
            >
              <span>{option.label}</span>
              {isSelected(option.value) && (
                <Icon class="size-4" name="mdi:check" />
              )}
            </button>
          )}
        </li>
      ))
    }
  </Stack>
</div>

<script>
  function initDropdowns() {
    const dropdowns = document.querySelectorAll<HTMLElement>('[data-dropdown]');

    dropdowns.forEach((dropdown) => {
      const id = dropdown.dataset.dropdown;
      if (!id) return;

      const trigger = dropdown.querySelector<HTMLButtonElement>(`[data-dropdown-trigger="${id}"]`);
      const menu = dropdown.querySelector<HTMLElement>(`[data-dropdown-menu="${id}"]`);
      const icon = dropdown.querySelector<HTMLElement>('.dropdown-icon');

      if (!trigger || !menu) return;

      let isOpen = false;

      const getItems = () => menu.querySelectorAll<HTMLElement>('[role="option"]');
      const getFirstItem = () => menu.querySelector<HTMLElement>('[role="option"]');
      const getLastItem = () => {
        const items = getItems();
        return items.length > 0 ? items[items.length - 1] : null;
      };

      const closeDropdown = () => {
        isOpen = false;
        menu.classList.remove('opacity-100', 'visible');
        menu.classList.add('opacity-0', 'invisible');
        icon?.classList.remove('rotate-180');
        trigger.setAttribute('aria-expanded', 'false');
        trigger.focus();
      };

      const openDropdown = () => {
        isOpen = true;
        menu.classList.remove('opacity-0', 'invisible');
        menu.classList.add('opacity-100', 'visible');
        icon?.classList.add('rotate-180');
        trigger.setAttribute('aria-expanded', 'true');
        getFirstItem()?.focus();
      };

      const toggleDropdown = () => {
        // Close all other dropdowns
        document.querySelectorAll<HTMLElement>('[data-dropdown-menu]').forEach((otherMenu) => {
          if (otherMenu !== menu) {
            otherMenu.classList.remove('opacity-100', 'visible');
            otherMenu.classList.add('opacity-0', 'invisible');
            const otherIcon = otherMenu.closest('[data-dropdown]')?.querySelector<HTMLElement>('.dropdown-icon');
            otherIcon?.classList.remove('rotate-180');
            const otherTrigger = otherMenu.closest('[data-dropdown]')?.querySelector<HTMLButtonElement>('[data-dropdown-trigger]');
            otherTrigger?.setAttribute('aria-expanded', 'false');
          }
        });

        if (isOpen) {
          closeDropdown();
        } else {
          openDropdown();
        }
      };

      // Toggle on click
      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleDropdown();
      });

      // Handle button items - close dropdown on click
      menu.querySelectorAll('button[data-value]').forEach((item) => {
        item.addEventListener('click', () => {
          closeDropdown();
        });
      });

      // Close on outside click
      document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target as Node)) {
          closeDropdown();
        }
      });

      // Handle escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isOpen) {
          e.preventDefault();
          closeDropdown();
        }
      });

      // Trigger keyboard navigation
      trigger.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          if (!isOpen) {
            toggleDropdown();
          } else {
            getFirstItem()?.focus();
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (!isOpen) {
            toggleDropdown();
          } else {
            getLastItem()?.focus();
          }
        }
      });

      // Menu keyboard navigation
      menu.addEventListener('keydown', (e) => {
        const items = getItems();
        const itemsArray = Array.from(items);
        const currentIndex = itemsArray.indexOf(document.activeElement as HTMLElement);

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          const nextIndex = currentIndex < itemsArray.length - 1 ? currentIndex + 1 : 0;
          itemsArray[nextIndex]?.focus();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          const prevIndex = currentIndex > 0 ? currentIndex - 1 : itemsArray.length - 1;
          itemsArray[prevIndex]?.focus();
        } else if (e.key === 'Home') {
          e.preventDefault();
          getFirstItem()?.focus();
        } else if (e.key === 'End') {
          e.preventDefault();
          getLastItem()?.focus();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          closeDropdown();
        } else if (e.key === 'Tab') {
          // Allow tab to close dropdown normally
          closeDropdown();
        }
      });
    });
  }

  initDropdowns();
  document.addEventListener('astro:page-load', initDropdowns);
</script>
