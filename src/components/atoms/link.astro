---
import type { HTMLAttributes } from 'astro/types';
import { Icon } from 'astro-icon/components';
import { cva, type VariantProps } from 'class-variance-authority';
import { cn } from '../../lib/cn';

const linkVariants = cva(
  'inline-flex items-center gap-1.5 transition-colors duration-200 ease-out focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background focus-visible:outline-none',
  {
    defaultVariants: {
      size: 'sm',
      variant: 'default',
    },
    variants: {
      size: {
        lg: 'text-lg',
        md: 'text-base',
        sm: 'text-sm',
      },
      variant: {
        back: 'group inline-flex items-center gap-2 text-sm text-muted-foreground no-underline',
        default: 'text-foreground decoration-1 underline-offset-4 hover:text-muted-foreground hover:underline',
        ghost: 'text-muted-foreground no-underline hover:text-foreground',
        icon: 'rounded-lg p-2 text-muted-foreground no-underline hover:bg-muted/50 hover:text-foreground',
        muted: 'text-muted-foreground/80 no-underline hover:text-muted-foreground',
        nav: 'relative py-1 text-sm font-medium transition-colors duration-200',
        primary: 'text-primary decoration-1 underline-offset-4 hover:text-primary/80 hover:underline',
      },
    },
  }
);

interface Props extends HTMLAttributes<'a'>, VariantProps<typeof linkVariants> {
  external?: boolean;
  href: string;
  icon?: string;
  withArrow?: boolean;
}

const {
  class: className,
  external,
  href,
  icon,
  size,
  variant,
  withArrow,
  ...props
} = Astro.props;

const isExternal = external ?? (href.startsWith('http') || href.startsWith('mailto'));
const target = isExternal ? '_blank' : undefined;
const rel = isExternal ? 'noopener noreferrer' : undefined;

const { pathname } = Astro.url;
const isActive = variant === 'nav' && (
  href === pathname ||
  (href !== '/' && pathname.startsWith(href))
);

const navActiveClasses = isActive
  ? "text-foreground after:absolute after:bottom-0 after:left-0 after:h-px after:w-full after:bg-primary after:content-['']"
  : "text-muted-foreground hover:text-foreground after:absolute after:bottom-0 after:left-0 after:h-px after:w-0 after:bg-muted-foreground after:transition-all after:duration-300 after:content-[''] hover:after:w-full";
---

<a
  class={cn(
    linkVariants({ className, size, variant }),
    variant === 'nav' && navActiveClasses,
    'group'
  )}
  href={href}
  rel={rel}
  target={target}
  {...props}
>
  {icon && (
    <Icon
      class={cn(
        'size-4',
        variant === 'back' && 'transition-transform group-hover:-translate-x-0.5'
      )}
      name={icon}
    />
  )}
  <slot />
  {withArrow && (
    <Icon
      class="size-3.5 opacity-60 transition-transform group-hover:translate-x-0.5"
      name="mdi:arrow-top-right"
    />
  )}
  {isExternal && !withArrow && variant !== 'icon' && (
    <span class="sr-only">(opens in new tab)</span>
  )}
</a>
