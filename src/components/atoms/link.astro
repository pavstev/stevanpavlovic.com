---
import type { HTMLAttributes } from 'astro/types';

import { Icon } from 'astro-icon/components';
import { cva, type VariantProps } from 'class-variance-authority';

const linkVariants = cva(
  'inline-flex items-center gap-2 transition-all focus-visible:ring-1 focus-visible:ring-ring focus-visible:outline-none',
  {
    defaultVariants: {
      size: 'default',
      variant: 'default',
    },
    variants: {
      size: {
        default: 'text-base',
        lg: 'text-lg',
        sm: 'text-sm',
      },
      variant: {
        back: 'group inline-flex items-center gap-2 rounded-full border border-border bg-muted/50 px-3 py-1.5 font-mono text-[10px] font-bold tracking-[0.2em] text-muted-foreground no-underline transition-all hover:border-primary/30 hover:bg-primary/5 hover:text-primary',
        button: 'rounded-md bg-primary px-4 py-2 font-medium text-primary-foreground no-underline shadow hover:bg-primary/90',
        default: 'text-foreground underline decoration-border underline-offset-4 hover:text-foreground/80 hover:decoration-muted-foreground',
        ghost: 'rounded-md px-3 py-1.5 text-muted-foreground no-underline transition-all hover:bg-accent hover:text-accent-foreground',
        muted: 'text-muted-foreground transition-colors hover:text-foreground',
        nav: 'relative inline-block py-1 text-sm font-medium transition-colors duration-300',
      }
    },
  }
);

interface Props extends HTMLAttributes<'a'>, VariantProps<typeof linkVariants> {
  external?: boolean;
  href: string;
  icon?: string;
  withArrow?: boolean;
}

const { class: className, external, href, icon, size, variant, withArrow, ...props } = Astro.props;

// Logic to determine if link is external automatically if not specified
const isExternal = external ?? (href.startsWith('http') || href.startsWith('mailto'));
const target = isExternal ? '_blank' : undefined;
const rel = isExternal ? 'noopener noreferrer' : undefined;

// Nav active state logic
const { pathname } = Astro.url;
const isActive = variant === 'nav' && (href === pathname || (href !== '/' && pathname.startsWith(href as string)));

const navActiveClasses = isActive
  ? "text-foreground after:absolute after:bottom-0 after:left-0 after:h-px after:w-full after:bg-primary after:content-['']"
  : "text-muted-foreground hover:text-foreground after:absolute after:bottom-0 after:left-0 after:h-px after:w-0 after:bg-muted-foreground after:transition-all after:duration-300 after:content-[''] hover:after:w-full";
---

<a
  class:list={[linkVariants({ className, size, variant }), variant === 'nav' && navActiveClasses, 'group']}
  href={href}
  rel={rel}
  target={target}
  {...props}
>
  {icon && (
    <Icon
      class:list={[
        'size-4',
        variant === 'back' && 'transition-transform group-hover:-translate-x-1'
      ]}
      name={icon}
    />
  )}
  <slot />
  {isExternal && !withArrow && variant !== 'button' && (
    <span class="sr-only">(opens in new tab)</span>
  )}
  {withArrow && (
    <Icon class="size-4 opacity-50 transition-transform group-hover:translate-x-0.5 group-hover:-translate-y-0.5" name="mdi:arrow-top-right" />
  )}
</a>
