---
import { Icon } from 'astro-icon/components';

import { cn } from '../../lib/cn';
import Heading from './heading.astro';
import Text from './text.astro';

interface Props {
  bodyClass?: string;
  class?: string;
  description?: string;
  id: string;
  title?: string;
}

const {
  bodyClass,
  class: className,
  description,
  id,
  title,
} = Astro.props;
---

<dialog
  aria-describedby={description ? `${id}-description` : undefined}
  aria-labelledby={title ? `${id}-title` : undefined}
  class="m-auto overflow-visible border-none bg-transparent p-0 outline-none backdrop:bg-black/80 backdrop:backdrop-blur-md"
  id={id}
>
  <div
    class:list={cn(
      "glass-strong relative flex flex-col rounded-3xl border border-white/10 shadow-2xl transition-all duration-500",
      "max-h-[85vh] w-full max-w-[calc(100vw-2rem)] sm:max-w-lg md:max-w-xl",
      className
    )}
  >
    {/* Optional Header */}
    {(title || description) && (
      <div class="flex flex-col gap-1.5 border-b border-white/5 p-6 pb-4">
        {title && (
          <Heading as="h2" class="text-xl font-bold tracking-tight" id={`${id}-title`} level={2}>
            {title}
          </Heading>
        )}
        {description && (
          <Text class="max-w-[90%]" id={`${id}-description`} size="xs" variant="muted">
            {description}
          </Text>
        )}
      </div>
    )}

    {/* Close Button - Always present and positioned correctly */}
    <form class="absolute top-4 right-4 z-51" method="dialog">
      <button
        aria-label="Close modal"
        class="flex size-9 items-center justify-center rounded-full bg-white/5 text-muted-foreground transition-all hover:bg-white/10 hover:text-foreground focus:ring-2 focus:ring-primary/40 focus:ring-offset-2 focus:ring-offset-background focus:outline-none"
      >
        <Icon class="size-5" name="mdi:close" />
      </button>
    </form>

    {/* Scrollable Content Body */}
    <div class:list={cn("scrollbar-thin scrollbar-thumb-white/10 scrollbar-track-transparent flex-1 overflow-y-auto p-6", bodyClass)}>
      <slot />
    </div>

    {/* Subtle bottom fade for long content */}
    <div class="pointer-events-none absolute bottom-0 left-0 h-12 w-full bg-linear-to-t from-black/20 to-transparent"></div>
  </div>
</dialog>

<script>
  import { initModals } from '../../lib/modal';

  const setupScrollLock = () => {
    const dialogs = document.querySelectorAll('dialog');

    dialogs.forEach(dialog => {
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'open') {
            if (dialog.hasAttribute('open')) {
              document.body.style.overflow = 'hidden';
              // Prevent layout shift by adding padding-right equal to scrollbar width
              const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
              if (scrollbarWidth > 0) {
                document.body.style.paddingRight = `${scrollbarWidth}px`;
              }
            } else {
              document.body.style.overflow = '';
              document.body.style.paddingRight = '';
            }
          }
        });
      });

      observer.observe(dialog, { attributes: true });

      dialog.addEventListener('close', () => {
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
      });
      dialog.addEventListener('cancel', () => {
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
      });
    });
  };

  const init = () => {
    initModals();
    setupScrollLock();
  }

  init();
  document.addEventListener('astro:page-load', init);
</script>

<style>
  dialog {
    /* Use fixed positioning to cover the screen, but use flex to center content */
    position: fixed;
    inset: 0;
    z-index: 100;
    display: flex; /* Flexbox for centering */
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    max-width: none;
    max-height: none;
    background: transparent;
    padding: 1rem; /* Safety padding from edges */
  }

  /* When closed, hide it completely (browser handles this usually, but safe to be explicit with display toggle) */
  dialog:not([open]) {
    display: none;
  }

  /* Backdrop standard styling */
  dialog::backdrop {
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(8px);
    opacity: 0;
  }

  /* Animations for dialog and backdrop */
  dialog[open] {
    animation: modal-enter 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  dialog[open]::backdrop {
    animation: backdrop-enter 0.4s ease-out forwards;
  }

  @keyframes modal-enter {
    from {
      opacity: 0;
      transform: scale(0.95) translateY(10px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  @keyframes backdrop-enter {
    to {
      opacity: 1;
    }
  }

  /* Custom scrollbar for better aesthetics */
  .scrollbar-thin::-webkit-scrollbar {
    width: 6px;
  }
</style>
