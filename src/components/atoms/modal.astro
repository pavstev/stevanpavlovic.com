---
import { Icon } from "astro-icon/components";

import { cn } from "../../lib/cn";

interface Props {
  caption?: string;
  class?: string;
  id: string;
  showCloseButton?: boolean;
}

const { caption, class: className, id, showCloseButton = true } = Astro.props;
---

<dialog
  class:list={cn(
    "group/modal m-auto bg-transparent p-0 focus:outline-none",
    "backdrop:bg-background/80 backdrop:backdrop-blur-xl",
    "open:animate-in open:fade-in open:zoom-in-95 open:duration-300",
    "before:absolute before:inset-0 before:rounded-2xl before:bg-linear-to-br before:from-primary/30 before:via-accent/20 before:to-secondary/30 before:opacity-20 before:blur-3xl before:grayscale",
  )}
  id={id}
>
  <div
    class:list={cn(
      "relative w-full max-w-lg overflow-hidden rounded-2xl border border-foreground/5 bg-card shadow-2xl backdrop-blur-sm",
      "hover:shadow-3xl transition-all duration-300",
      "before:absolute before:-inset-1 before:-z-10 before:rounded-2xl before:bg-linear-to-br before:from-primary/20 before:via-accent/10 before:to-secondary/20 before:opacity-5 before:blur-3xl before:grayscale",
      className,
    )}
  >
    <div class="absolute inset-0 rounded-2xl bg-card/50 backdrop-blur-sm"></div>
    <div class="relative z-10 p-6">
      {
        showCloseButton && (
          <button
            aria-label="Close"
            class="close-modal-btn absolute top-4 right-4 cursor-pointer rounded-full p-1 text-muted-foreground transition-all duration-300 hover:scale-105 hover:bg-foreground/10 hover:text-foreground hover:shadow-lg focus:scale-105 focus:ring-2 focus:ring-foreground/20 focus:outline-none active:scale-95 active:shadow-md"
            type="button"
          >
            <Icon class="size-5 transition-all duration-300 hover:scale-110 hover:rotate-90" name="mdi:close-thick" />
          </button>
        )
      }

      <slot />

      {
        caption && (
          <div class="mt-4 border-t border-foreground/10 pt-4">
            <div class="text-sm leading-relaxed text-muted-foreground">{caption}</div>
          </div>
        )
      }
    </div>
  </div>
</dialog>

<script>
  function initModals() {
    const dialogs = document.querySelectorAll("dialog.group\\/modal");

    dialogs.forEach((dialog) => {
      if (!(dialog instanceof HTMLDialogElement)) return;

      const closeBtn = dialog.querySelector(".close-modal-btn");

      const close = () => {
        dialog.close();
        document.body.style.overflow = "";
      };

      // Close on backdrop click
      dialog.addEventListener("click", (e) => {
        if (e.target === dialog) {
          close();
        }
      });

      // Close button
      closeBtn?.addEventListener("click", close);

      // Handle scroll lock when open
      // We can't easily detect "open" property change without MutationObserver calling back.
      // But showing is usually done via .showModal() called externally.
      // The script opening it should handle scroll lock?
      // Or we can observe attributes.
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === "attributes" && mutation.attributeName === "open") {
            if (dialog.open) {
              document.body.style.overflow = "hidden";
              // force focus?
            } else {
              document.body.style.overflow = "";
            }
          }
        });
      });
      observer.observe(dialog, { attributes: true });
    });
  }

  initModals();
  document.addEventListener("astro:page-load", initModals);
</script>
