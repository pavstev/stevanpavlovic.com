---
import { Icon } from "astro-icon/components";
import { NAV_ITEMS } from "../../lib/config";
import { isActivePath } from "../../lib/nav";
import Logo from "../atoms/logo.astro";
import Container from "../molecules/container.astro";
import MobileMenuToggle from "../molecules/mobile-menu-toggle.astro";
import MobileMenu from "../molecules/mobile-menu.astro";
import Search from "../organisms/search.astro";
import LayoutWrapper from "./layout-wrapper.astro";

const { pathname } = Astro.url;
const isActive = (href: string) => isActivePath(pathname, href);
---

<header
  class="fixed top-4 z-50 w-full px-4 transition-all duration-500 md:px-0"
  id="site-header"
  transition:persist
>
  <Container>
    <LayoutWrapper class="items-center">
      {/* Main Bar */}
      <div class="glass relative flex h-14 w-full items-center justify-between gap-4 rounded-full px-2 shadow-2xl transition-all duration-500 hover:border-white/20">

        {/* Left: Logo */}
        <div class="flex shrink-0 items-center pl-2">
          <Logo />
        </div>

        {/* Center: Search */}
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 hidden md:block">
          <div class="group/search relative flex items-center transition-all duration-300">
            <Icon class="absolute left-3 size-4 text-muted-foreground transition-colors group-focus-within/search:text-primary" name="mdi:magnify" />
            <input
              type="text"
              placeholder="Search..."
              id="header-search-input"
              class="h-9 w-48 lg:w-64 rounded-full border border-white/10 bg-white/5 pl-9 pr-12 text-sm transition-all hover:bg-white/10 focus:border-primary/50 focus:bg-white/10 focus:ring-2 focus:ring-primary/20 outline-none"
            />
            <kbd class="absolute right-3 hidden h-5 items-center gap-1 rounded bg-white/10 px-1.5 font-mono text-[10px] font-medium opacity-50 sm:flex">
              <span class="text-xs">âŒ˜</span>K
            </kbd>
          </div>
        </div>

        {/* Search Modal */}
        <Search />

        {/* Right: Nav & Mobile Toggle */}
        <div class="flex items-center gap-2 pr-1">
          {/* Mobile Search Toggle (Visible only on mobile) */}
          <button
            aria-label="Open search"
            class="flex size-9 items-center justify-center rounded-full bg-white/5 text-muted-foreground transition-all hover:bg-white/10 hover:text-foreground md:hidden"
            id="mobile-search-trigger"
          >
            <Icon name="mdi:magnify" class="size-5" />
          </button>
          {/* Desktop Nav */}
          <nav class="hidden items-center gap-1 md:flex" id="desktop-nav">
            {NAV_ITEMS.map((item) => {
              const active = isActive(item.href);
              return (
                <a
                  class:list={[
                    "relative rounded-full px-3 py-1.5 text-sm font-medium transition-all duration-300",
                    {"bg-white/10 text-foreground shadow-sm": active, "text-muted-foreground hover:bg-white/5 hover:text-foreground": !active}
                  ]}
                  data-nav-link
                  href={item.href}
                >
                  {item.label}
                </a>
              );
            })}
          </nav>

          {/* Socials Removed (Moved to Footer) */}

          {/* Mobile Toggle */}
          <MobileMenuToggle size="sm" />
        </div>
      </div>
    </LayoutWrapper>
  </Container>
</header>

<MobileMenu navItems={NAV_ITEMS} />

<script>
  import { initMobileMenu, updateActiveLinks } from '../../lib/mobile-menu';

  const initSearchTrigger = () => {
    const headerInput = document.getElementById('header-search-input') as HTMLInputElement;
    const mobileTrigger = document.getElementById('mobile-search-trigger');
    const modal = document.getElementById('search-modal') as HTMLDialogElement;

    if (!modal) return;

    const openModal = () => {
      if (modal.open) return;
      modal.showModal();
      setTimeout(() => {
        const modalInput = modal.querySelector('input');
        if (modalInput) {
          if (headerInput && headerInput.value) {
            modalInput.value = headerInput.value;
            // Trigger input event for Pagefind
            modalInput.dispatchEvent(new Event('input', { bubbles: true }));
          }
          modalInput.focus();
        }
      }, 50);
    };

    if (headerInput) {
      headerInput.addEventListener('click', openModal);
    }

    if (mobileTrigger) {
      mobileTrigger.addEventListener('click', openModal);
    }
  };

  const init = () => {
    initMobileMenu();
    updateActiveLinks();
    initSearchTrigger();
  };

  init();
  document.addEventListener('astro:page-load', init);
  document.addEventListener('astro:after-swap', updateActiveLinks); // Ensure updates on client nav
</script>
