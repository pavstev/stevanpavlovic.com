---
import { Icon } from 'astro-icon/components';
import { NAV_ITEMS, PROFILE } from "../../lib/config";
import { isActivePath } from "../../lib/nav";
import Spacer from "../atoms/spacer.astro";
import Text from "../atoms/text.astro";
import Container from "../molecules/container.astro";
import IdentitySection from "../molecules/identity-section.astro";
import InteractiveAvatar from "../molecules/interactive-avatar.astro";
import MobileMenuToggle from "../molecules/mobile-menu-toggle.astro";
import MobileMenu from "../molecules/mobile-menu.astro";
import SearchBar from "../molecules/search-bar.astro";
import Search from "../molecules/search.astro";
import SocialIcons from "../molecules/social-icons.astro";

const { pathname } = Astro.url;
const isActive = (href: string) => isActivePath(pathname, href);
---

<header
  class="fixed top-4 z-50 w-full px-4 md:px-0 transition-all duration-500"
  id="site-header"
  transition:persist
>
  <Container class="max-w-5xl">
    <div class="relative flex flex-col items-center">
      {/* Main Bar */}
      <div class="glass flex h-14 w-full items-center justify-between gap-4 rounded-full px-2 shadow-2xl transition-all duration-500 hover:border-white/20">

        {/* Identity */}
        <IdentitySection class="pl-2">
          <InteractiveAvatar class="shrink-0" size="sm" slot="avatar" />
          <Text
            as="span"
            class="hidden sm:block cursor-default text-sm font-bold tracking-tight text-foreground"
            slot="name"
          >
            {PROFILE.name}
          </Text>
        </IdentitySection>

        <Spacer />

        {/* Desktop Nav */}
        <nav class="hidden items-center gap-1 md:flex" id="desktop-nav">
          {NAV_ITEMS.map((item) => {
            const active = isActive(item.href);
            return (
              <a
                href={item.href}
                class:list={[
                  "relative flex items-center gap-2 rounded-full px-4 py-2 text-xs font-medium transition-all duration-300",
                  active ? "bg-white/10 text-foreground shadow-sm" : "text-muted-foreground hover:text-foreground hover:bg-white/5"
                ]}
              >
                {active && <Icon name={item.icon} class="size-3" />}
                {item.label}
              </a>
            );
          })}
        </nav>

        <div class="hidden md:flex items-center gap-2 pr-2">
           <SocialIcons />
        </div>

        {/* Mobile Toggle */}
        <MobileMenuToggle size="sm" />
      </div>

      {/* Search Bar attached */}
      <SearchBar>
        <Search />
      </SearchBar>
    </div>
  </Container>
</header>

<MobileMenu navItems={NAV_ITEMS} />

<script>
  import { initMobileMenu, updateActiveLinks } from '../../lib/mobile-menu';

  const init = () => {
    initMobileMenu();
    updateActiveLinks();
  };

  init();
  document.addEventListener('astro:page-load', init);
</script>
