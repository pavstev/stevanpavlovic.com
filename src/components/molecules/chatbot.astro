---
import { Icon } from 'astro-icon/components';
import { cva, type VariantProps } from 'class-variance-authority';

import { cn } from '../../lib/cn';
import { cardVariants } from '../../lib/card-helpers';
import { buttonVariants } from '../../atoms/button.astro';

// ============================================================================
// Message Bubble Variants
// ============================================================================

const messageVariants = cva(
  'max-w-[85%] rounded-2xl px-4 py-2.5 text-sm leading-relaxed',
  {
    defaultVariants: {
      variant: 'ai',
    },
    variants: {
      variant: {
        ai: 'rounded-tl-none bg-muted/80 text-foreground/90',
        user: 'rounded-tr-none bg-primary text-primary-foreground ml-auto',
      },
    },
  },
);

interface Message {
  text: string;
  isAi: boolean;
  id: string;
}

// ============================================================================
// Chatbot Props
// ============================================================================

interface Props {
  class?: string;
}

const { class: className } = Astro.props;

// ============================================================================
// Resume Context (Server-side)
// ============================================================================

const RESUME_CONTEXT = `
  Stevan Pavlovic is a Senior Software Engineer and Technical Lead with over 10 years of experience.
  He specializes in building scalable web applications, leading technical teams, and implementing modern development practices.
  Based in Belgrade, Serbia.
`.trim();

// ============================================================================
// Component Template
// ============================================================================
---

<div
  class={cn('relative z-[100] flex flex-col items-end print:hidden', className)}
  id="chatbot-widget"
>
  {/* Chat Window */}
  <div
    class={cn(
      cardVariants({ variant: 'glass', className: 'pointer-events-none mb-4 w-[340px] max-w-[calc(100vw-2rem)] translate-y-4 opacity-0 shadow-xl transition-all duration-300 ease-out sm:w-[400px]' }),
      'overflow-hidden',
      'data-[open=true]:pointer-events-auto data-[open=true]:translate-y-0 data-[open=true]:opacity-100'
    )}
    data-open="false"
    id="chat-window"
  >
    {/* Header */}
    <header class="flex items-center justify-between border-b border-white/10 bg-white/5 px-4 py-3">
      <div class="flex items-center gap-3">
        <div class="flex size-8 items-center justify-center rounded-full bg-primary/20 text-primary">
          <Icon name="mdi:robot-outline" size={16} />
        </div>
        <div class="flex flex-col">
          <span class="text-xs font-bold tracking-tight text-foreground uppercase">Resume Assistant</span>
          <span class="text-[10px] text-muted-foreground" id="chat-status">Ready to help</span>
        </div>
      </div>
      <button
        class={cn(buttonVariants({ variant: 'ghost', size: 'icon' }), 'size-8')}
        id="close-chat"
        aria-label="Close chat"
      >
        <Icon name="mdi:close" size={18} />
      </button>
    </header>

    {/* Messages Area */}
    <div
      class="scrollbar-thin flex h-[400px] flex-col gap-3 overflow-y-auto p-4"
      id="chat-messages"
    >
      {/* Welcome Message */}
      <div class="flex flex-col gap-1">
        <div class={cn(messageVariants({ variant: 'ai' }))}>
          Hi! I'm Stevan's AI assistant. Ask me anything about his experience, skills, or projects.
        </div>
        <span class="text-[10px] text-muted-foreground/60 px-1">Powered by AI</span>
      </div>
    </div>

    {/* Input Area */}
    <div class="border-t border-white/10 bg-white/5 p-3">
      <form class="flex gap-2" id="chat-form">
        <div class="relative flex-1">
          <input
            class="w-full rounded-full border border-white/10 bg-black/30 px-4 py-2.5 pr-10 text-sm text-foreground placeholder:text-muted-foreground focus:border-primary/50 focus:ring-1 focus:ring-primary/50 focus:outline-none transition-all"
            id="chat-input"
            placeholder="Ask about Stevan's experience..."
            type="text"
          />
          <div class="absolute right-3 top-1/2 -translate-y-1/2">
            <Icon class="text-muted-foreground/50" name="mdi:message-outline" size={16} />
          </div>
        </div>
        <button
          class={cn(buttonVariants({ variant: 'primary', size: 'icon' }), 'size-10 shrink-0 shadow-lg shadow-primary/20')}
          id="send-button"
          type="submit"
          aria-label="Send message"
        >
          <Icon name="mdi:send" size={18} />
        </button>
      </form>
    </div>
  </div>

  {/* Toggle Button */}
  <button
    class="group relative flex size-12 items-center justify-center rounded-full bg-primary text-primary-foreground shadow-xl shadow-primary/25 transition-all duration-300 hover:scale-110 hover:shadow-primary/40 active:scale-95 sm:size-13"
    id="chat-toggle"
    aria-label="Toggle Chatbot"
  >
    {/* Robot Icon (visible when closed) */}
    <Icon
      class="transition-all duration-300 group-data-[open=true]:scale-0 group-data-[open=true]:rotate-90"
      name="mdi:robot-outline"
      size={24}
    />
    {/* Close Icon (visible when open) */}
    <Icon
      class="absolute scale-0 transition-all duration-300 group-data-[open=true]:scale-100 group-data-[open=true]:rotate-0"
      name="mdi:close"
      size={24}
    />
    {/* Pulse Effect */}
    <span class="absolute inset-0 rounded-full animate-ping bg-primary/30 opacity-0 group-data-[open=false]:opacity-75"></span>
  </button>
</div>

<script define:vars={{ RESUME_CONTEXT }}>
  // ============================================================================
  // Type Definitions
  // ============================================================================

  interface ChatMessage {
    id: string;
    text: string;
    isAi: boolean;
  }

  // ============================================================================
  // State
  // ============================================================================

  let qaPipeline: any = null;
  let isInitializing = false;
  let isProcessing = false;

  // ============================================================================
  // DOM Elements
  // ============================================================================

  const toggleBtn = document.getElementById('chat-toggle');
  const chatWindow = document.getElementById('chat-window') as HTMLElement;
  const messagesContainer = document.getElementById('chat-messages') as HTMLElement;
  const chatForm = document.getElementById('chat-form') as HTMLFormElement;
  const chatInput = document.getElementById('chat-input') as HTMLInputElement;
  const statusEl = document.getElementById('chat-status');
  const closeBtn = document.getElementById('close-chat');

  // ============================================================================
  // Utility Functions
  // ============================================================================

  function generateId(): string {
    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }

  function scrollToBottom(): void {
    messagesContainer.scrollTo({
      top: messagesContainer.scrollHeight,
      behavior: 'smooth',
    });
  }

  function updateStatus(text: string): void {
    if (statusEl) {
      statusEl.textContent = text;
    }
  }

  // ============================================================================
  // Message Rendering
  // ============================================================================

  function createMessageElement(message: ChatMessage): HTMLElement {
    const container = document.createElement('div');
    container.className = `flex flex-col gap-1 animate-in fade-in slide-in-from-bottom-2 duration-200 ${message.isAi ? '' : 'items-end'}`;

    const messageBubble = document.createElement('div');
    messageBubble.className = `max-w-[85%] rounded-2xl px-4 py-2.5 text-sm leading-relaxed ${
      message.isAi
        ? 'rounded-tl-none bg-muted/80 text-foreground/90'
        : 'rounded-tr-none bg-primary text-primary-foreground ml-auto'
    }`;
    messageBubble.textContent = message.text;

    const timestamp = document.createElement('span');
    timestamp.className = 'text-[10px] text-muted-foreground/60 px-1';
    timestamp.textContent = message.isAi ? 'AI' : 'You';

    container.appendChild(messageBubble);
    container.appendChild(timestamp);

    return container;
  }

  function createTypingIndicator(): HTMLElement {
    const container = document.createElement('div');
    container.className = 'flex flex-col gap-1 animate-in fade-in';
    container.id = 'typing-indicator';

    const bubble = document.createElement('div');
    bubble.className = 'flex items-center gap-1 rounded-2xl rounded-tl-none bg-muted/80 px-4 py-3';
    bubble.innerHTML = `
      <span class="inline-block size-2 animate-bounce rounded-full bg-muted-foreground/60" style="animation-delay: 0ms;"></span>
      <span class="inline-block size-2 animate-bounce rounded-full bg-muted-foreground/60" style="animation-delay: 150ms;"></span>
      <span class="inline-block size-2 animate-bounce rounded-full bg-muted-foreground/60" style="animation-delay: 300ms;"></span>
    `;

    const timestamp = document.createElement('span');
    timestamp.className = 'text-[10px] text-muted-foreground/60 px-1';
    timestamp.textContent = 'AI';

    container.appendChild(bubble);
    container.appendChild(timestamp);

    return container;
  }

  function addMessage(text: string, isAi: boolean): void {
    const message: ChatMessage = {
      id: generateId(),
      text,
      isAi,
    };
    const element = createMessageElement(message);
    messagesContainer.appendChild(element);
    scrollToBottom();
  }

  function removeTypingIndicator(): void {
    const typing = document.getElementById('typing-indicator');
    if (typing) {
      typing.remove();
    }
  }

  // ============================================================================
  // AI Model Management
  // ============================================================================

  async function initModel(): Promise<void> {
    if (qaPipeline || isInitializing) return;
    isInitializing = true;
    updateStatus('Loading AI model...');

    try {
      // Dynamically import transformers
      const { pipeline } = await import('@xenova/transformers');
      qaPipeline = await pipeline('question-answering', 'Xenova/distilbert-base-uncased-distilled-squad');
      updateStatus('Ready to help');
      setTimeout(() => updateStatus('Ready to help'), 2000);
    } catch (err) {
      console.error('Failed to load model:', err);
      updateStatus('Error loading model');
    } finally {
      isInitializing = false;
    }
  }

  // ============================================================================
  // Event Handlers
  // ============================================================================

  function toggleChat(): void {
    const isOpen = chatWindow.dataset.open === 'true';
    const newState = !isOpen;

    chatWindow.dataset.open = String(newState);
    toggleBtn.dataset.open = String(newState);

    if (newState) {
      initModel();
      setTimeout(() => chatInput.focus(), 300);
    }
  }

  function closeChat(): void {
    chatWindow.dataset.open = 'false';
    toggleBtn.dataset.open = 'false';
  }

  async function handleSubmit(e: Event): Promise<void> {
    e.preventDefault();

    if (isProcessing) return;

    const question = chatInput.value.trim();
    if (!question) return;

    // Clear input and add user message
    chatInput.value = '';
    chatInput.disabled = true;
    isProcessing = true;

    addMessage(question, false);

    // Initialize model if needed
    if (!qaPipeline) {
      addMessage("I'm initializing the AI model. Give me a moment...", true);
      await initModel();
    }

    // Show typing indicator
    const typingIndicator = createTypingIndicator();
    messagesContainer.appendChild(typingIndicator);
    scrollToBottom();

    try {
      // Get AI response
      const result = await qaPipeline(question, RESUME_CONTEXT);
      removeTypingIndicator();
      addMessage(result.answer || "I'm not sure about that. You might want to check Stevan's full profile!", true);
    } catch (err) {
      console.error('Error processing question:', err);
      removeTypingIndicator();
      addMessage("Sorry, I encountered an error while processing your request. Please try again.", true);
    } finally {
      chatInput.disabled = false;
      isProcessing = false;
      chatInput.focus();
    }
  }

  // ============================================================================
  // Event Listeners
  // ============================================================================

  toggleBtn?.addEventListener('click', toggleChat);
  closeBtn?.addEventListener('click', closeChat);
  chatForm?.addEventListener('submit', handleSubmit);

  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && chatWindow.dataset.open === 'true') {
      closeChat();
    }
  });

  // Close on backdrop click (optional enhancement)
  // chatWindow.addEventListener('click', (e) => {
  //   if (e.target === chatWindow) closeChat();
  // });
</script>

<style is:global>
  /* Custom scrollbar for chat - matching global patterns */
  .scrollbar-thin::-webkit-scrollbar {
    width: 5px;
  }

  .scrollbar-thin::-webkit-scrollbar-track {
    background: transparent;
  }

  .scrollbar-thin::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
  }

  .scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  /* Smooth message animations */
  @keyframes slide-in-from-bottom-2 {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-in {
    animation: slide-in-from-bottom-2 0.2s ease-out forwards;
  }
</style>
