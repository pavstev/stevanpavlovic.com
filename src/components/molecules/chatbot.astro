---
import Icon from "../atoms/icon.astro";

/**
 * RAG Chatbot UI
 * A floating, intelligent assistant powered by local Web Workers.
 * Features auto-typing, source citation, and a clean glassmorphic UI.
 */
---

<!-- Chat Widget Container -->
<div class="pointer-events-none fixed right-6 bottom-6 z-[100] flex flex-col items-end font-sans" id="rag-widget">
  <!-- Main Window -->
  <div
    class="pointer-events-auto invisible mb-4 flex h-[600px] w-[380px] origin-bottom-right translate-y-8 scale-95 flex-col overflow-hidden rounded-2xl border border-border bg-card/95 opacity-0 shadow-2xl backdrop-blur-xl transition-all duration-300"
    id="rag-window"
  >
    <!-- Header -->
    <div class="flex items-center justify-between border-b border-border bg-muted/50 p-4 backdrop-blur-md">
      <div class="flex items-center gap-3">
        <div
          class="relative flex size-10 items-center justify-center rounded-full bg-primary/10 text-primary ring-1 ring-border/50"
        >
          <Icon class="size-6" name="mdi:robot-happy-outline" />
          <span
            class="absolute right-0 bottom-0 block size-2.5 rounded-full bg-green-500 ring-2 ring-card"
            id="rag-status-indicator"></span>
        </div>
        <div>
          <h3 class="text-sm font-bold text-foreground">Stevan's Assistant</h3>
          <p class="text-[10px] text-muted-foreground" id="rag-status-text">Offline</p>
        </div>
      </div>
      <button
        class="rounded-lg p-1.5 text-muted-foreground transition-colors hover:bg-muted hover:text-foreground"
        id="rag-close"
      >
        <Icon name="mdi:close" size="sm" />
      </button>
    </div>

    <!-- Messages Container -->
    <div
      class="scrollbar-thin scrollbar-thumb-border scrollbar-track-transparent flex-1 space-y-6 overflow-y-auto p-4"
      id="rag-messages"
    >
      <!-- Intro Message -->
      <div class="animate-in fade-in slide-in-from-bottom-2 flex gap-3 duration-500">
        <div class="mt-1 flex size-8 shrink-0 items-center justify-center rounded-full bg-primary/10 text-primary">
          <Icon name="mdi:robot" size="sm" />
        </div>
        <div
          class="max-w-[85%] rounded-2xl rounded-tl-none bg-muted px-4 py-3 text-sm leading-relaxed text-foreground shadow-sm"
        >
          <p>
            Hello! I'm a local AI running entirely in your browser. I've analyzed Stevan's portfolio and experience. Ask
            me anything!
          </p>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="border-t border-border bg-background/50 p-4 backdrop-blur-md">
      <form class="relative flex items-center gap-2" id="rag-form">
        <input
          autocomplete="off"
          class="flex-1 rounded-xl border border-input bg-background/50 px-4 py-3 text-sm shadow-sm transition-all placeholder:text-muted-foreground focus:border-primary focus:ring-1 focus:ring-primary focus:outline-none disabled:cursor-not-allowed disabled:opacity-50"
          disabled
          id="rag-input"
          placeholder="Ask a question..."
          type="text"
        />
        <button
          class="absolute top-1/2 right-2 -translate-y-1/2 rounded-lg bg-primary p-2 text-primary-foreground shadow-md transition-all hover:bg-primary/90 disabled:cursor-not-allowed disabled:opacity-50"
          disabled
          id="rag-submit"
          type="submit"
        >
          <Icon name="mdi:send" size="sm" />
        </button>
      </form>
      <div class="mt-2 flex justify-center">
        <p class="text-[10px] text-muted-foreground/50">Powered by Transformers.js â€¢ Private & Local</p>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div
      class="absolute inset-0 z-20 flex flex-col items-center justify-center bg-background/80 backdrop-blur-sm transition-opacity duration-300"
      id="rag-loading-overlay"
    >
      <div class="mb-4 size-12 animate-spin rounded-full border-4 border-primary border-t-transparent"></div>
      <p class="text-xs font-medium text-foreground" id="rag-loader-text">Initializing AI Engine...</p>
      <div class="mt-2 h-1.5 w-32 overflow-hidden rounded-full bg-muted">
        <div class="h-full w-0 bg-primary transition-all duration-300" id="rag-loader-bar"></div>
      </div>
    </div>
  </div>

  <!-- Floating Action Button -->
  <button
    aria-label="Open AI Chat"
    class="group pointer-events-auto flex size-14 items-center justify-center rounded-full bg-primary text-primary-foreground shadow-[0_4px_14px_0_rgba(0,0,0,0.39)] transition-all duration-300 hover:scale-110 hover:shadow-[0_6px_20px_rgba(0,0,0,0.23)] active:scale-95"
    id="rag-toggle"
  >
    <Icon class="size-6 transition-transform duration-500 group-hover:rotate-12" name="mdi:sparkles" />
  </button>
</div>

<script>
  import { RagChat } from "../../lib/chatbot";
  new RagChat();
</script>
