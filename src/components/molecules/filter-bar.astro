---


import Dropdown from './dropdown.astro';
import Pagination from './pagination.astro';

interface Props {
  activeFilter?: string;
  activeSort?: string;
  baseUrl: string;
  filters: { label: string; value: string }[];
  pagination?: {
    currentPage: number;
    nextUrl: null | string;
    prevUrl: null | string;
    totalPages: number;
  };
  sortOptions?: { label: string; value: string }[];
}

const props = Astro.props;
const activeFilter = props.activeFilter ?? 'all';
const activeSort = props.activeSort ?? 'newest';
const baseUrl = props.baseUrl;
const filters = props.filters;
const sortOptions = props.sortOptions ?? [
  { label: 'Newest', value: 'newest' },
  { label: 'Oldest', value: 'oldest' },
  { label: 'Alphabetical (A-Z)', value: 'a-z' },
  { label: 'Alphabetical (Z-A)', value: 'z-a' }
];
const pagination = props.pagination;

const currentFilterLabel = activeFilter === 'all'
  ? 'All Topics'
  : filters.find(f => f.value.toLowerCase() === activeFilter.toLowerCase())?.label || 'All Topics';

const currentSortLabel = sortOptions.find(s => s.value === activeSort)?.label || 'Newest';

// Use helper
import { buildFilterLink } from '../../lib/filter-helpers';
const buildLink = (type: 'filter' | 'sort', value: string) => buildFilterLink(type, value, Astro.url, baseUrl);

// Prepare items for dropdowns
const filterItems = [
  {
    active: !activeFilter || activeFilter === 'all',
    href: buildLink('filter', 'all'),
    label: 'All Topics'
  },
  ...filters.map(filter => ({
    active: activeFilter?.toLowerCase() === filter.value.toLowerCase(),
    href: buildLink('filter', filter.value),
    label: filter.label
  }))
];

const sortItems = sortOptions.map(option => ({
  active: activeSort === option.value,
  href: buildLink('sort', option.value),
  label: option.label
}));
---

<div class="filter-bar-component mb-8 w-full border-b border-border/50 pb-4">
  <div class="flex w-full flex-col gap-4 md:flex-row md:items-center md:justify-between">

    <div class="flex flex-col gap-4 md:flex-row md:items-center">
      {/* Filters (Dropdown) */}
      <Dropdown
        icon="mdi:filter-variant"
        items={filterItems}
        label={currentFilterLabel}
        mobileFullWidth={true}
      />

      {/* Sort (Dropdown) */}
      <Dropdown
        icon="mdi:sort"
        items={sortItems}
        label={currentSortLabel}
      />
    </div>

    {/* Pagination (Compact) */}
    {
      pagination && (
        <Pagination
          currentPage={pagination.currentPage}
          nextUrl={pagination.nextUrl}
          prevUrl={pagination.prevUrl}
          totalPages={pagination.totalPages}
        />
      )
    }
  </div>

  <script>
    import { initDropdowns } from '../../lib/dropdown';

    initDropdowns();
    document.addEventListener('astro:page-load', initDropdowns);
  </script>
</div>
