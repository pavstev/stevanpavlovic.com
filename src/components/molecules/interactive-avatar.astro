---
import { Image } from 'astro:assets';

import { PROFILE } from '../../lib/config';
import Avatar from '../atoms/avatar.astro';

interface Props {
  class?: string;
  size?: 'lg' | 'md' | 'sm' | 'xl';
}

const { class: className, size = 'md' } = Astro.props;
const modalId = 'avatar-modal';
---

<>
  <button
    aria-label="View profile picture"
    class:list={[
      "group relative cursor-pointer transition-transform duration-200 outline-none active:scale-95",
      "hover:scale-110 focus-visible:scale-110",
      className
    ]}
    onclick={`document.getElementById('${modalId}').showModal()`}
    type="button"
  >
    <div class="relative overflow-hidden rounded-full ring-2 ring-transparent transition-all duration-300 group-hover:ring-primary/50">
      <Avatar
        alt={PROFILE.name}
        class="transition-transform duration-500 group-hover:scale-110"
        size={size}
        src={PROFILE.avatar}
      />
    </div>
  </button>

  {/* Simplified Modal with only zoomable avatar, no duplicate close button */}
  <dialog
    class="m-auto h-screen max-h-none! w-screen max-w-none! bg-transparent p-0 backdrop:animate-fade-in backdrop:bg-black/90 open:flex open:animate-[zoom-in_0.3s_cubic-bezier(0.34,1.56,0.64,1)]"
    id={modalId}
  >
    <div class="relative flex size-full flex-col items-center justify-center overflow-hidden">
      {/* Single Close Button - using modal's built-in close button */}
      <form class="absolute top-4 right-4 z-50" method="dialog">
        <button class="flex items-center justify-center rounded-full border border-white/20 bg-black/50 p-2 text-white backdrop-blur-md transition-all hover:border-primary/50 hover:bg-white/10">
          <svg fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
          <span class="sr-only">Close</span>
        </button>
      </form>

      {/* Zoomable Image Container */}
      <div
        class="zoom-container relative flex size-full items-center justify-center overflow-hidden"
        data-avatar-zoom
      >
        <Image
          alt={PROFILE.name}
          class="max-h-[90vh] max-w-[95vw] cursor-zoom-in object-contain transition-transform duration-100 ease-out hover:scale-[2.5]"
          height={1000}
          src={PROFILE.avatar}
          style="will-change: transform"
          width={1000}
        />
      </div>
    </div>
  </dialog>
</>

<script>
  import { initAvatarZoom } from '../../lib/avatar';

  initAvatarZoom();
  document.addEventListener('astro:page-load', initAvatarZoom);
</script>

<style>
  .zoom-container {
    touch-action: none;
  }

  dialog::backdrop {
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(8px);
  }

  @keyframes zoom-in {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  @keyframes fade-in {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
</style>
