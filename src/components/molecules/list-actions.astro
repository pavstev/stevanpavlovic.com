---
import { Icon } from 'astro-icon/components';

import Button from '../atoms/button.astro';
import Dropdown, { type DropdownOption } from '../atoms/dropdown.astro';

export interface FilterConfig {
  id: string;
  label: string;
  options: DropdownOption[];
  selectedValue?: string;
  selectedValues?: string[];
}

export type ViewMode = 'list' | 'masonry-2' | 'masonry-3';

interface Props {
  baseUrl: string;
  currentPage: number;
  filters?: FilterConfig[];
  itemCountLabel?: string;
  itemsPerPage?: number;
  resetHref?: string;
  showItemCount?: boolean;
  showItemsPerPage?: boolean;
  showViewToggle?: boolean;
  totalItems?: number;
  totalPages: number;
  viewMode?: ViewMode;
}

const {
  baseUrl,
  currentPage,
  filters = [],
  itemsPerPage = 9,
  resetHref,
  showItemsPerPage = true,
  showViewToggle = true,
  totalPages,
  viewMode = 'list',
} = Astro.props;

// Helper to get pagination URL
function getPageUrl(page: number): string {
  const url = new URL(baseUrl, 'http://localhost');
  if (page === 1) {
    url.searchParams.delete('page');
  } else {
    url.searchParams.set('page', String(page));
  }
  if (viewMode !== 'list') {
    url.searchParams.set('view', viewMode);
  }
  return url.pathname + url.search;
}

// Build view mode URLs
function getViewUrl(mode: ViewMode): string {
  const url = new URL(baseUrl, 'http://localhost');
  url.searchParams.set('view', mode);
  if (currentPage > 1) {
    url.searchParams.set('page', String(currentPage));
  }
  return url.pathname + url.search;
}

const viewModes: { icon: string; label: string; mode: ViewMode; }[] = [
  { icon: 'mdi:format-list-bulleted', label: 'List', mode: 'list' },
  { icon: 'mdi:view-column', label: '2 Columns', mode: 'masonry-2' },
  { icon: 'mdi:view-dashboard', label: '3 Columns', mode: 'masonry-3' },
];

// Items per page options
const itemsPerPageOptions = [
  { label: '6', value: '6' },
  { label: '9', value: '9' },
  { label: '12', value: '12' },
  { label: '24', value: '24' },
];

// Build items per page URL
function getItemsPerPageHref(count: number): string {
  const url = new URL(baseUrl, 'http://localhost');
  url.searchParams.set('limit', String(count));
  return url.pathname + url.search;
}
---

<div class="list-actions w-full">
  {/* Single row - filters left, pagination center, view toggle right */}
  <div class="flex flex-wrap items-center gap-2 border-b border-border pb-4 sm:gap-3">
    {/* Left: Filters */}
    <div class="flex flex-wrap items-center gap-2 sm:gap-3">
      {filters.map((filter) => (
        <Dropdown
          align="left"
          id={`filter-${filter.id}`}
          label={filter.label}
          options={filter.options}
          selectedValue={filter.selectedValue}
          size="sm"
          variant="outline"
        />
      ))}

      {resetHref && (
        <Button
          as="a"
          class="h-7 px-2 text-xs"
          href={resetHref}
          size="sm"
          variant="ghost"
        >
          <Icon class="mr-1 size-3.5" name="mdi:refresh" />
          Reset
        </Button>
      )}
    </div>

    {/* Spacer */}
    <div class="min-w-[1rem] flex-1"></div>

    {/* Right: Pagination + Items per page + View toggle */}
    <div class="flex flex-wrap items-center gap-2 sm:gap-3">
      {/* Items per page dropdown */}
      {showItemsPerPage && (
        <Dropdown
          align="right"
          id="items-per-page"
          label={`${itemsPerPage}`}
          options={itemsPerPageOptions.map((opt) => ({
            ...opt,
            href: getItemsPerPageHref(Number(opt.value)),
          }))}
          selectedValue={String(itemsPerPage)}
          size="sm"
          variant="outline"
        />
      )}

      {/* Pagination */}
      {totalPages > 1 && (
        <nav aria-label="Pagination">
          <div class="flex items-center justify-center gap-0.5 rounded-lg bg-muted/50 p-0.5 sm:gap-1 sm:p-1">
            <Button
              as="a"
              class="size-7 rounded-md p-0 sm:size-8"
              disabled={currentPage === 1}
              href={currentPage > 1 ? getPageUrl(currentPage - 1) : undefined}
              size="icon"
              variant="ghost"
            >
              <Icon class="size-3.5 sm:size-4" name="mdi:chevron-left" />
              <span class="sr-only">Previous page</span>
            </Button>

            <div class="flex items-center px-2 sm:px-3">
              <span class="text-xs font-medium text-foreground tabular-nums sm:text-sm">
                {currentPage}
              </span>
              <span class="mx-1 text-xs text-muted-foreground sm:text-sm">
                /
              </span>
              <span class="text-xs text-muted-foreground tabular-nums sm:text-sm">
                {totalPages}
              </span>
            </div>

            <Button
              as="a"
              class="size-7 rounded-md p-0 sm:size-8"
              disabled={currentPage === totalPages}
              href={currentPage < totalPages ? getPageUrl(currentPage + 1) : undefined}
              size="icon"
              variant="ghost"
            >
              <Icon class="size-3.5 sm:size-4" name="mdi:chevron-right" />
              <span class="sr-only">Next page</span>
            </Button>
          </div>
        </nav>
      )}

      {/* View toggle */}
      {showViewToggle && (
        <div class="flex items-center rounded-lg border border-border bg-background p-0.5 shadow-sm sm:p-1">
          {viewModes.map(({ icon, label, mode }) => (
            <Button
              aria-pressed={viewMode === mode}
              as="a"
              class:list={[`size-7 rounded-md p-0 transition-all sm:size-8`, {
                'bg-accent text-accent-foreground shadow-sm': viewMode === mode,
                'text-muted-foreground hover:bg-muted hover:text-foreground': viewMode !== mode,
              }]}
              href={getViewUrl(mode)}
              size="icon"
              title={label}
              variant="ghost"
            >
              <Icon class="size-3.5 sm:size-4" name={icon} />
              <span class="sr-only">{label} view</span>
            </Button>
          ))}
        </div>
      )}
    </div>
  </div>
</div>
