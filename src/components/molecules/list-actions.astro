---
import { Icon } from 'astro-icon/components';

import Button from '../atoms/button.astro';
import Dropdown, { type DropdownOption } from '../atoms/dropdown.astro';

export type ViewMode = 'list' | 'masonry-2' | 'masonry-3';

export interface FilterConfig {
  id: string;
  label: string;
  options: DropdownOption[];
  selectedValue?: string;
  selectedValues?: string[];
}

interface Props {
  baseUrl: string;
  currentPage: number;
  totalPages: number;
  totalItems?: number;
  viewMode?: ViewMode;
  filters?: FilterConfig[];
  showViewToggle?: boolean;
  showItemCount?: boolean;
  itemCountLabel?: string;
  resetHref?: string;
}

const {
  baseUrl,
  currentPage,
  totalPages,
  viewMode = 'list',
  filters = [],
  showViewToggle = true,
  resetHref,
} = Astro.props;

// Build view mode URLs preserving existing params
function getViewUrl(mode: ViewMode): string {
  const url = new URL(baseUrl, 'http://localhost');
  url.searchParams.set('view', mode);
  if (currentPage > 1) {
    url.searchParams.set('page', String(currentPage));
  }
  return url.pathname + url.search;
}

// Helper to get pagination URL
function getPageUrl(page: number): string {
  const url = new URL(baseUrl, 'http://localhost');
  if (page === 1) {
    url.searchParams.delete('page');
  } else {
    url.searchParams.set('page', String(page));
  }
  if (viewMode !== 'list') {
    url.searchParams.set('view', viewMode);
  }
  return url.pathname + url.search;
}

const viewModes: { mode: ViewMode; icon: string; label: string }[] = [
  { mode: 'list', icon: 'mdi:format-list-bulleted', label: 'List' },
  { mode: 'masonry-2', icon: 'mdi:view-column', label: '2 Columns' },
  { mode: 'masonry-3', icon: 'mdi:view-dashboard', label: '3 Columns' },
];
---

<div class="list-actions w-full">
  {/* Single row - filters left, pagination center, view toggle right */}
  <div class="flex flex-wrap items-center gap-2 sm:gap-3 border-b border-border pb-4">
    {/* Left: Filters */}
    <div class="flex items-center gap-2 sm:gap-3 flex-wrap">
      {filters.map((filter) => (
        <Dropdown
          align="left"
          id={`filter-${filter.id}`}
          label={filter.label}
          options={filter.options}
          selectedValue={filter.selectedValue}
          size="sm"
          variant="outline"
        />
      ))}
      
      {resetHref && (
        <Button
          as="a"
          class="h-7 px-2 text-xs"
          href={resetHref}
          size="sm"
          variant="ghost"
        >
          <Icon class="size-3.5 mr-1" name="mdi:refresh" />
          Reset
        </Button>
      )}
    </div>

    {/* Spacer to push pagination and view toggle apart */}
    <div class="flex-1 min-w-[1rem]"></div>

    {/* Center/Right: Pagination */}
    {totalPages > 1 && (
      <nav aria-label="Pagination" class="order-last sm:order-none w-full sm:w-auto mt-2 sm:mt-0">
        <div class="flex items-center justify-center gap-0.5 sm:gap-1 bg-muted/50 rounded-lg p-0.5 sm:p-1">
          <Button
            as="a"
            class="h-7 w-7 sm:h-8 sm:w-8 p-0 rounded-md"
            disabled={currentPage === 1}
            href={currentPage > 1 ? getPageUrl(currentPage - 1) : undefined}
            size="icon"
            variant="ghost"
          >
            <Icon class="size-3.5 sm:size-4" name="mdi:chevron-left" />
            <span class="sr-only">Previous page</span>
          </Button>

          <div class="flex items-center px-2 sm:px-3">
            <span class="text-xs sm:text-sm font-medium tabular-nums text-foreground">
              {currentPage}
            </span>
            <span class="text-xs sm:text-sm text-muted-foreground mx-1">
              /
            </span>
            <span class="text-xs sm:text-sm tabular-nums text-muted-foreground">
              {totalPages}
            </span>
          </div>

          <Button
            as="a"
            class="h-7 w-7 sm:h-8 sm:w-8 p-0 rounded-md"
            disabled={currentPage === totalPages}
            href={currentPage < totalPages ? getPageUrl(currentPage + 1) : undefined}
            size="icon"
            variant="ghost"
          >
            <Icon class="size-3.5 sm:size-4" name="mdi:chevron-right" />
            <span class="sr-only">Next page</span>
          </Button>
        </div>
      </nav>
    )}

    {/* Right: View Toggle */}
    {
      showViewToggle && (
        <div class="flex items-center rounded-lg border border-border bg-background p-0.5 sm:p-1 shadow-sm">
          {viewModes.map(({ mode, icon, label }) => (
            <Button
              aria-pressed={viewMode === mode}
              as="a"
              class={`${viewMode === mode ? 'bg-accent text-accent-foreground shadow-sm' : 'hover:bg-muted text-muted-foreground hover:text-foreground'} h-7 w-7 sm:h-8 sm:w-8 p-0 rounded-md transition-all`}
              href={getViewUrl(mode)}
              size="icon"
              title={label}
              variant="ghost"
            >
              <Icon class="size-3.5 sm:size-4" name={icon} />
              <span class="sr-only">{label} view</span>
            </Button>
          ))}
        </div>
      )
    }
  </div>
</div>
