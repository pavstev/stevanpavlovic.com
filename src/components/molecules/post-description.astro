---
import AppIcon from "../atoms/app-icon.astro";
import ToolbarItem from "../atoms/toolbar-item.astro";

interface Props {
  description: string | undefined;
}

const { description } = Astro.props;
---

{
  description && (
    <div class="min-w-0">
      <ToolbarItem label="Description">
        <div class="relative w-full">
          <details class="group/description text-sm font-medium text-muted-foreground group-hover/toolbar:text-foreground">
            <summary class="cursor-pointer list-none transition-colors hover:text-primary [&::-webkit-details-marker]:hidden">
              <div class="description-text line-clamp-4 leading-relaxed tracking-tight text-foreground/70 transition-all duration-300 group-open/description:line-clamp-none">
                {description}
              </div>
              <div class="toggle-buttons mt-3 hidden">
                <div class="group-open/description:hidden">
                  <div class="inline-flex items-center gap-2 border border-primary/20 bg-primary/5 px-2 py-0.5 text-[10px] font-bold tracking-widest text-primary uppercase transition-all duration-300 hover:bg-primary/10 hover:shadow-[0_0_15px_var(--color-primary)]">
                    <span class="size-1 animate-pulse-neon rounded-full bg-primary shadow-[0_0_8px_var(--color-primary)]" />
                    Expand Record
                    <AppIcon name="mdi:chevron-down" size="sm" />
                  </div>
                </div>
                <div class="hidden group-open/description:block">
                  <div class="inline-flex items-center gap-2 border border-foreground/10 bg-foreground/5 px-2 py-0.5 text-[10px] font-bold tracking-widest text-foreground/50 uppercase transition-all duration-300 hover:border-primary/20 hover:text-primary">
                    Collapse
                    <AppIcon name="mdi:chevron-up" size="sm" />
                  </div>
                </div>
              </div>
            </summary>
          </details>
        </div>
      </ToolbarItem>
    </div>
  )
}

<script>
  function setupDescriptionToggles() {
    // Escape the slash in group/description for the selector
    const descriptions = document.querySelectorAll("details.group\\/description");

    descriptions.forEach((details) => {
      const text = details.querySelector(".description-text") as HTMLElement;
      const toggleWrapper = details.querySelector(".toggle-buttons") as HTMLElement;

      if (!text || !toggleWrapper) return;

      // Reset state to measure correctly
      const isCurrentlyOpen = (details as HTMLDetailsElement).open;
      if (isCurrentlyOpen) {
        (details as HTMLDetailsElement).open = false;
      }

      // Check if text is truncated
      const isTruncated = text.scrollHeight > text.offsetHeight;

      if (isTruncated) {
        toggleWrapper.classList.remove("hidden");
        toggleWrapper.classList.add("flex");
      } else {
        toggleWrapper.classList.add("hidden");
        toggleWrapper.classList.remove("flex");
        (details.querySelector("summary") as HTMLElement).style.cursor = "default";
      }

      // Restore state
      if (isCurrentlyOpen) {
        (details as HTMLDetailsElement).open = true;
      }
    });
  }

  // Run on mount and after a short delay to ensure layout
  document.addEventListener("astro:page-load", setupDescriptionToggles);
  setupDescriptionToggles();
  window.addEventListener("resize", setupDescriptionToggles);

  // Also watch for class changes or other potential triggers
  setTimeout(setupDescriptionToggles, 100);
</script>
