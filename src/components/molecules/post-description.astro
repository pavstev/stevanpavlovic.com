---
import AppIcon from "../atoms/app-icon.astro";
import ToolbarItem from "../atoms/toolbar-item.astro";

interface Props {
  description: string | undefined;
}

const { description } = Astro.props;
---

{
  description && (
    <div class="min-w-0">
      <ToolbarItem label="Description">
        <div class="relative w-full">
          <details class="group/desc text-sm font-medium text-muted-foreground group-hover/toolbar:text-foreground">
            <summary class="cursor-pointer list-none transition-colors hover:text-primary [&::-webkit-details-marker]:hidden">
              <div class="description-text line-clamp-4 leading-relaxed group-open/desc:line-clamp-none">
                {description}
              </div>
              <div class="toggle-buttons mt-3 hidden">
                <div class="hover:shadow-glow-subtle inline-flex items-center gap-1 rounded-full border border-primary/10 bg-primary/5 px-2.5 py-1 text-[10px] font-bold tracking-tight text-primary transition-all duration-300 group-open/desc:hidden hover:border-primary/20 hover:bg-primary/10">
                  Read full description <AppIcon name="mdi:chevron-down" size="xs" />
                </div>
                <div class="hover:shadow-glow-subtle mt-2 hidden items-center gap-1 rounded-full border border-primary/10 bg-primary/5 px-2.5 py-1 text-[10px] font-bold tracking-tight text-primary transition-all duration-300 group-open/desc:inline-flex hover:border-primary/20 hover:bg-primary/10">
                  Show less <AppIcon name="mdi:chevron-up" size="xs" />
                </div>
              </div>
            </summary>
          </details>
        </div>
      </ToolbarItem>
    </div>
  )
}

<script>
  function setupDescriptionToggles() {
    const descriptions = document.querySelectorAll("details.group/desc");

    descriptions.forEach((details) => {
      const text = details.querySelector(".description-text") as HTMLElement;
      const toggleWrapper = details.querySelector(".toggle-buttons") as HTMLElement;

      if (!text || !toggleWrapper) return;

      // Check if text is truncated
      const isTruncated = text.scrollHeight > text.offsetHeight;

      if (isTruncated) {
        toggleWrapper.classList.remove("hidden");
      } else {
        // If not truncated, disable details click to avoid empty toggle
        details.addEventListener("click", (_e) => {
          const detailEl = details as HTMLDetailsElement;
          if (!detailEl.open) {
            // Prevent opening if it doesn't overflow
          }
        });
        (details.querySelector("summary") as HTMLElement).style.cursor = "default";
      }
    });
  }

  // Run on mount and after a short delay to ensure layout
  setupDescriptionToggles();
  window.addEventListener("resize", setupDescriptionToggles);
</script>
