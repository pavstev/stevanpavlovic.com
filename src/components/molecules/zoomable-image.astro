---
import type { ImageMetadata } from 'astro';

import { Icon } from 'astro-icon/components';
import { Image } from 'astro:assets';

import Modal from '../atoms/modal.astro';
import Text from '../atoms/text.astro';
import FormattedDate from '../atoms/formatted-date.astro';
import Stack from '../atoms/stack.astro';

interface Props {
  alt: string;
  class?: string;
  fileSize?: string; // e.g. "2.4 MB" - manually passed for now
  height?: number;
  loading?: "eager" | "lazy";
  src: ImageMetadata | string;
  uploadDate?: Date;
  width?: number;
}

const { alt, class: className, fileSize, height, loading = "lazy", src, uploadDate, width } = Astro.props;

// Unique ID for this instance's modal
const modalId = `zoom-modal-${Math.random().toString(36).substring(2, 11)}`;
const imageSrc = typeof src === 'string' ? src : src.src;
const imageWidth = typeof src === 'string' ? width : src.width;
const imageHeight = typeof src === 'string' ? height : src.height;
---

<button
  aria-label={`Zoom image: ${alt}`}
  class:list={["group relative block w-full cursor-zoom-in overflow-hidden border-none bg-transparent p-0", className]}
  onclick={`document.getElementById('${modalId}').showModal()`}
  type="button"
>

  {typeof src === 'string' ? (
    <img
      alt={alt}
      class="size-full object-cover transition-transform duration-500 group-hover:scale-105"
      loading={loading}
      src={src}
    />
  ) : (
    <Image
      alt={alt}
      class="size-full object-cover transition-transform duration-500 group-hover:scale-105"
      height={height}
      loading={loading}
      src={src}
      width={width}
    />
  )}

  {/* Hover hint */}
  <div class="absolute inset-0 flex items-center justify-center bg-black/0 opacity-0 transition-colors duration-300 group-hover:bg-black/10 group-hover:opacity-100">
    <div class="rounded-full bg-black/50 p-3 text-foreground backdrop-blur-sm">
      <Icon name="mdi:magnify-plus-outline" size={24} />
    </div>
  </div>
</button>

<Modal class="h-screen max-h-none! w-screen max-w-none! bg-transparent p-0 backdrop:bg-black/90" id={modalId}>
  <div class="relative flex size-full flex-col items-center justify-center overflow-hidden">

    {/* Close Button (Fixed Top Right) */}

    <form class="absolute top-4 right-4 z-50" method="dialog">

      <button class="flex items-center justify-center rounded-full border border-border bg-black/50 p-2 text-foreground backdrop-blur-md transition-colors hover:bg-secondary">

        <Icon name="mdi:close" size={24} />

      </button>

    </form>



    {/* Image Container */}

    <div

      class="zoom-container relative flex size-full items-center justify-center overflow-hidden"

      data-image-zoom

    >

      <img

        alt={alt}

        class="max-h-[85vh] max-w-[95vw] object-contain transition-transform duration-100 ease-out hover:scale-[2.5]"

        src={imageSrc}

        style="will-change: transform"

      />

    </div>



    {/* Metadata Bar */}

    <div class="pointer-events-none absolute bottom-6 left-1/2 z-50 w-full max-w-xl -translate-x-1/2 px-4">

      <div class="pointer-events-auto flex items-center justify-between gap-4 rounded-md border border-border bg-muted/80 p-4 shadow-2xl backdrop-blur-xl">

        <Stack gap={1}>

          <Text class="line-clamp-1 font-medium text-foreground" size="sm">{alt || 'Image Preview'}</Text>

          <div class="flex items-center gap-3 font-mono text-xs text-muted-foreground">

            {imageWidth && imageHeight && (

              <span class="flex items-center gap-1">

                <Icon name="mdi:image-size-select-actual" size={14} />

                {imageWidth} Ã— {imageHeight}

              </span>

            )}

            {fileSize && (

              <span class="flex items-center gap-1 border-l border-border pl-3">

                <Icon name="mdi:file-outline" size={14} />

                {fileSize}

              </span>

            )}

          </div>

        </Stack>



        {uploadDate && (

          <div class="hidden text-right sm:block">

            <Text class="tracking-wider uppercase" size="xs" variant="muted">Uploaded</Text>

            <Text class="font-mono text-foreground/80" size="xs">

              <FormattedDate date={uploadDate} />

            </Text>

          </div>

        )}

      </div>

    </div>


  </div>
</Modal>

<script>
  import { initImageZoom } from '../../lib/image-zoom';

  initImageZoom();
  document.addEventListener('astro:page-load', initImageZoom);
</script>

<style>
  /* Remove default modal styles that might conflict */
  :global(#zoom-modal-container) {
    padding: 0;
  }

  /* Hide scrollbars in modal */
  .zoom-container {
    touch-action: none;
  }
</style>
