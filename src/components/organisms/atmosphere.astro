---
import AppIcon from "../atoms/app-icon.astro";
---

<div class="group/widget relative">
  <!-- Main Widget -->
  <button
    aria-label="Check availability and time"
    class="atmosphere-card group flex items-center gap-3 rounded-full border border-(--color-border) bg-(--color-card) px-4 py-2 backdrop-blur-md transition-all hover:border-(--color-ring) hover:shadow-lg focus:ring-2 focus:ring-(--color-ring) focus:outline-none"
    id="atmosphere-trigger"
  >
    <!-- Status Dot -->
    <div class="status-container relative flex size-2">
      <span class="ping-effect absolute inline-flex size-full animate-ping rounded-full opacity-75" id="atmo-ping"
      ></span>
      <span class="status-dot relative inline-flex size-2 rounded-full transition-colors duration-500" id="atmo-dot"
      ></span>
    </div>

    <!-- Text Content -->
    <div class="content-wrapper flex flex-col items-start leading-none">
      <span class="time-text text-xs font-bold text-(--color-foreground) tabular-nums" id="atmo-time">Loading...</span>
      <span class="weather-text mt-0.5 text-[10px] text-(--color-muted-foreground)" id="atmo-status"
        >Checking status...</span
      >
    </div>

    <!-- Globe Icon -->
    <div class="icon-wrapper text-(--color-muted-foreground) transition-colors group-hover:text-(--color-primary)">
      <AppIcon name="mdi:earth" size="sm" />
    </div>
  </button>

  <!-- Time Zone Popover -->
  <div
    class="invisible absolute right-0 bottom-full z-50 mb-3 w-72 origin-bottom-right scale-95 overflow-hidden rounded-xl border border-(--color-border) bg-(--color-popover) opacity-0 shadow-xl transition-all duration-200 ease-out"
    id="timezone-popover"
  >
    <div class="space-y-4 p-4">
      <div class="flex items-center justify-between border-b border-(--color-border) pb-3">
        <h4 class="text-sm font-bold text-(--color-foreground)">Time Check</h4>
        <span class="rounded-full bg-(--color-secondary) px-2 py-0.5 text-[10px] text-(--color-secondary-foreground)"
          >Belgrade, RS</span
        >
      </div>

      <!-- Comparison Visualizer -->
      <div class="space-y-3">
        <!-- My Time -->
        <div class="flex items-center justify-between text-xs">
          <div class="flex items-center gap-2">
            <AppIcon class="text-(--color-primary)" name="mdi:account-circle" size="sm" />
            <span class="font-medium text-(--color-foreground)">Stevan</span>
          </div>
          <span class="font-mono text-(--color-muted-foreground)" id="popover-stevan-time">--:--</span>
        </div>

        <!-- Connection Line -->
        <div class="relative h-1 w-full overflow-hidden rounded-full bg-(--color-secondary)">
          <div
            class="absolute top-0 left-0 h-full w-1/2 bg-(--color-primary) transition-all duration-500"
            id="time-overlap-bar"
          >
          </div>
        </div>

        <!-- User Time -->
        <div class="flex items-center justify-between text-xs">
          <div class="flex items-center gap-2">
            <AppIcon class="text-(--color-muted-foreground)" name="mdi:account-outline" size="sm" />
            <span class="font-medium text-(--color-foreground)">You</span>
          </div>
          <span class="font-mono text-(--color-muted-foreground)" id="popover-user-time">--:--</span>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="grid grid-cols-2 gap-2 pt-1">
        <button
          class="tz-btn group flex flex-col items-center justify-center gap-1 rounded-lg bg-(--color-secondary) p-2 text-xs transition-colors hover:bg-(--color-accent)"
          data-offset="-6"
        >
          <AppIcon
            class="text-(--color-muted-foreground) group-hover:text-(--color-primary)"
            name="mdi:briefcase-clock"
            size="sm"
          />
          <span class="text-(--color-foreground)">New York</span>
        </button>
        <button
          class="tz-btn group flex flex-col items-center justify-center gap-1 rounded-lg bg-(--color-secondary) p-2 text-xs transition-colors hover:bg-(--color-accent)"
          data-offset="8"
        >
          <AppIcon
            class="text-(--color-muted-foreground) group-hover:text-(--color-primary)"
            name="mdi:weather-sunset"
            size="sm"
          />
          <span class="text-(--color-foreground)">Tokyo</span>
        </button>
      </div>

      <p class="text-center text-[10px] text-(--color-muted-foreground) italic" id="availability-msg">
        "Usually available for calls 2pm-6pm CET"
      </p>
    </div>
  </div>
</div>

<script>
  import { AtmosphereWidget } from "../../lib/atmosphere";
  new AtmosphereWidget();
</script>
