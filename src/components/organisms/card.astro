---
import type { HTMLAttributes } from 'astro/types';

import { Icon } from 'astro-icon/components';
import { type VariantProps } from 'class-variance-authority';

import { type CardData, cardVariants } from '../../lib/card-helpers';
import { cn } from '../../lib/cn';
import Badge from '../atoms/badge.astro';
import FormattedDate from '../atoms/formatted-date.astro';
import Heading from '../atoms/heading.astro';
import IconBox from '../atoms/icon-box.astro';
import Text from '../atoms/text.astro';
import CardImage from '../molecules/card-image.astro';
import CardSpotlight from '../molecules/card-spotlight.astro';
import Tags from '../molecules/tags.astro';

interface BaseProps extends HTMLAttributes<'div'>, Omit<VariantProps<typeof cardVariants>, 'variant'> {
  as?: string;
  glowColor?: string;
  visual?: 'default' | 'ghost' | 'glass' | 'outline';
}

interface Props extends BaseProps {
  actionIcon?: string;
  actionLabel?: string;
  data?: CardData;
  headingLevel?: number;
  list?: boolean;
  loading?: 'eager' | 'lazy';
}

const props = Astro.props;
const { actionIcon = 'mdi:arrow-right', actionLabel, class: className, data: _data, glowColor = 'var(--color-primary)', headingLevel = 3, interactive, list, loading, visual = 'default', ...rest } = props;
// Default to empty object if undefined
const data = _data || {};

// Destructure data properties
const { align = 'start', animate, date, delay = 0, description, footerMeta, icon, image, meta, subtitle, tags, title, url } = data;

// Determine Card State
const hasData = Object.keys(data).length > 0;
const isSimpleCard = !hasData;

// Layout Helpers
const Wrapper = url ? 'a' : 'div';
const cardClasses = cn(cardVariants({ className, interactive: !!url || interactive, variant: visual }));

// Determine Layout Mode
// If it's a list view, we use row layout. Otherwise default column.
// Note: Icon cards (with icon) are typically grid/column based.
const isRowLayout = list && !icon;
---

{isSimpleCard ? (
  <Wrapper
    class:list={cn(cardClasses)}
    href={url}
    style={{ '--glow-color': glowColor }}
    {...rest}
  >
    <CardSpotlight glowColor={glowColor} />
    <slot />
  </Wrapper>
) : (
  <Wrapper class:list={cn("group block", !isRowLayout && "h-full")} href={url} {...rest}>
    <div
      class:list={cn(
        cardClasses,
        isRowLayout ? "flex-row gap-4 p-4!" : "h-full flex-col gap-4",
        align === 'center' && !isRowLayout ? 'items-center text-center' : 'items-start',
        animate && 'animate-in fade-in slide-in-from-bottom-4 duration-700'
      )}
      style={{ '--glow-color': glowColor, animationDelay: `${delay}ms` }}
    >
      {/* Background Effects */}
      <CardSpotlight glowColor={glowColor} />

      {/* Media Section: Icon */}
      {icon && (
        <div class="relative">
          <div class="absolute -inset-2 bg-primary/10 opacity-0 blur-2xl transition-opacity duration-300 group-hover:opacity-100"></div>
          <IconBox
            class="relative border-foreground/10 bg-foreground/5 transition-all duration-300 group-hover:scale-105 group-hover:border-primary/20 group-hover:bg-primary/5"
            size="lg"
            variant="glass"
          >
            <Icon class="transition-colors duration-300 group-hover:text-accent" name={isRowLayout ? icon : icon} size={24} />
          </IconBox>
        </div>
      )}

      {/* Media Section: Image */}
      {image && (
        <CardImage
          alt={title || ""}
          image={image}
          loading={loading}
          wrapperClass={isRowLayout ? "hidden size-20 shrink-0 sm:block lg:size-24" : "mb-0 aspect-video w-full rounded-2xl"}
        />
      )}

      {/* Content Section */}
      <div class:list={cn("flex w-full min-w-0 flex-1 flex-col", isRowLayout ? "gap-0" : "gap-4")}>

        {/* Header Row */}
        <div class:list={cn("flex w-full justify-between gap-4", isRowLayout ? "flex-row" : "flex-col sm:flex-row")}>
          <div class:list={cn("flex flex-col", isRowLayout ? "gap-0" : "gap-1")}>
            {/* Date (List View / Grid View) */}
            {date && (
              <div class:list={cn("flex items-center justify-between", !isRowLayout && "mb-1")}>
                <Text class="font-mono tracking-wider uppercase" size="xs" variant="muted">
                  <FormattedDate date={date} full />
                </Text>
              </div>
            )}

            {/* Title */}
            <Heading
              class:list={cn("transition-colors group-hover:text-primary", isRowLayout ? "mt-1 line-clamp-1" : "line-clamp-2")}
              level={headingLevel as 1 | 2 | 3 | 4 | 5 | 6}
              size={isRowLayout ? "md" : "lg"}
            >
              {title}
            </Heading>

            {/* Subtitle */}
            {subtitle && (
              <Text
                class:list={cn("font-mono tracking-wider uppercase", isRowLayout ? "mt-0.5" : "mt-1")}
                size="xs"
                variant="muted"
              >
                {subtitle}
              </Text>
            )}
          </div>

          {/* Right Side: Meta & Action */}
          <div class:list={cn("flex items-center gap-2 self-start", align === 'center' && !isRowLayout ? "hidden" : "")}>
            {meta && <Badge variant="secondary">{meta}</Badge>}

            {url && (
              <div class="relative flex min-h-[24px] min-w-[24px] items-center justify-end font-mono">
                <div class:list={cn("absolute right-0 flex items-center text-muted-foreground transition-all duration-300", actionLabel ? "group-hover:-translate-x-2 group-hover:opacity-0" : "group-hover:translate-x-1 group-hover:-translate-y-1 group-hover:text-primary")}>
                  <Icon name="mdi:arrow-top-right" />
                </div>
                {actionLabel && (
                  <div class="flex items-center gap-1 text-[10px] font-bold tracking-widest text-primary uppercase opacity-0 transition-all duration-300 group-hover:translate-x-0 group-hover:opacity-100">
                    {actionLabel}
                    <Icon class="size-3" name={actionIcon} />
                  </div>
                )}
              </div>
            )}
          </div>
        </div>

        {/* Body: Description */}
        {description && (
          <Text class:list={cn("text-muted-foreground", isRowLayout ? "mt-2 line-clamp-1" : "line-clamp-2 flex-1")} size="sm">
            {description}
          </Text>
        )}

        {/* Footer Section */}
        <div class:list={cn("mt-auto flex items-center", isRowLayout ? "gap-2" : "w-full justify-between")}>

          {/* Tags */}
          {tags && tags.length > 0 && (
            <div class:list={cn(isRowLayout ? "mt-2" : "")}>
              <Tags limit={isRowLayout ? 4 : 3} tags={tags} />
            </div>
          )}

          {/* Footer Meta (e.g. Experience Date Range) */}
          {footerMeta && (
            <Text class="ml-auto font-mono tracking-wider whitespace-nowrap uppercase transition-colors group-hover:text-primary/80" size="xs" variant="muted">
              {footerMeta}
            </Text>
          )}



          {/* Icon Card Bottom Arrow (if no meta/header arrow used) */}
          {icon && url && (
            <Icon class="size-4 text-muted-foreground/50 group-hover:text-primary" name="mdi:arrow-top-right" />
          )}

        </div>
      </div>
    </div>
  </Wrapper>
)}

<script is:inline>
  function initInteractiveCards() {
    const cards = document.querySelectorAll(".group\\/card");

    for (const card of cards) {
      if (!(card instanceof HTMLElement)) {
        continue;
      }

      const handleMouseMove = (e) => {
        const rect = card.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        card.style.setProperty("--mouse-x", String(x) + "px");
        card.style.setProperty("--mouse-y", String(y) + "px");
      };

      card.addEventListener("mousemove", handleMouseMove);
    }
  }

  initInteractiveCards();
  document.addEventListener('astro:page-load', initInteractiveCards);
</script>
