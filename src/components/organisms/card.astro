---
import type { ImageMetadata } from "astro";
import type { HTMLAttributes } from "astro/types";

import { cva, type VariantProps } from "class-variance-authority";

import type { Tag } from "../../lib/collections";

import AppIcon from "../atoms/app-icon.astro";
import Badge from "../atoms/badge.astro";
import FormattedDate from "../atoms/formatted-date.astro";
import Heading from "../atoms/heading.astro";
import IconBox from "../atoms/icon-box.astro";
import Text from "../atoms/text.astro";
import CardImage from "../molecules/card-image.astro";
import CardSpotlight from "../molecules/card-spotlight.astro";
import Tags from "../molecules/tags.astro";

const variants = cva(
  "group/card relative flex w-full flex-col overflow-hidden rounded-2xl border transition-all duration-300",
  {
    defaultVariants: {
      interactive: false,
      variant: "default",
    },
    variants: {
      interactive: {
        false: "",
        true: "cursor-pointer hover:-translate-y-1 hover:shadow-2xl hover:shadow-primary/5",
      },
      variant: {
        default: "border-border/50 bg-card/50 backdrop-blur-md hover:border-primary/20",
        ghost: "border-transparent bg-transparent hover:bg-foreground/5",
        glass: "glass hover:bg-background/60",
        outline: "border-2 border-border/50 bg-transparent hover:border-primary/20",
      },
    },
  },
);

export interface CardData {
  align?: "center" | "start";
  animate?: boolean;
  date?: Date;
  delay?: number;
  description?: string;
  footerMeta?: string;
  icon?: string;
  image?: ImageMetadata | string;
  logo?: ImageMetadata;
  meta?: string;
  subtitle?: string;
  tags?: Tag[];
  title?: string;
  url?: string;
}

interface BaseProps extends HTMLAttributes<"div">, Omit<VariantProps<typeof variants>, "variant"> {
  as?: any;
  glowColor?: string;
  visual?: "default" | "ghost" | "glass" | "outline";
}

interface Props extends BaseProps {
  actionIcon?: string;
  actionLabel?: string;
  data?: CardData;
  headingLevel?: number;
  list?: boolean;
  loading?: "eager" | "lazy";
}

const props = Astro.props;
const {
  actionIcon = "mdi:arrow-right",
  actionLabel,
  class: className,
  data: _data,
  glowColor = "var(--color-primary)",
  headingLevel = 3,
  interactive,
  list,
  loading,
  visual = "default",
  ...rest
} = props;

const data = _data || {};

const {
  align = "start",
  animate,
  date,
  delay = 0,
  description,
  footerMeta,
  icon,
  image,
  logo,
  meta,
  subtitle,
  tags,
  title,
  url,
} = data;

const hasData = Object.keys(data).length > 0;
const isSimpleCard = !hasData;

const Wrapper = (url ? "a" : "div") as any;
const cardClasses = variants({ className, interactive: !!url || interactive, variant: visual });

const isRowLayout = list && !icon;
---

{
  isSimpleCard ? (
    <Wrapper class:list={[cardClasses]} href={url} style={{ "--glow-color": glowColor }} {...rest}>
      <CardSpotlight glowColor={glowColor} />
      <slot />
    </Wrapper>
  ) : (
    <Wrapper class:list={["group block", !isRowLayout && "h-full"]} href={url} {...rest}>
      <div
        class:list={[
          cardClasses,
          isRowLayout ? "flex-row gap-4 p-4!" : "h-full flex-col gap-4 p-5 sm:p-6",
          align === "center" && !isRowLayout ? "items-center text-center" : "items-start",
          animate && "animate-in fade-in slide-in-from-bottom-4 duration-700",
        ]}
        style={{ "--glow-color": glowColor, animationDelay: `${delay}ms` }}
      >
        <CardSpotlight glowColor={glowColor} />

        {icon && (
          <div class="relative">
            <div class="absolute -inset-4 bg-primary/10 opacity-0 blur-2xl transition-opacity duration-500 group-hover:opacity-100" />
            <IconBox
              class="relative border-border/50 bg-foreground/5 group-hover:border-primary/30 group-hover:bg-primary/5"
              icon={icon}
              iconSize="lg"
              size="xl"
              variant="default"
            />
          </div>
        )}

        {image && (
          <CardImage
            alt={title || ""}
            image={image}
            loading={loading}
            wrapperClass={
              isRowLayout ? "hidden size-20 shrink-0 sm:block lg:size-24" : "mb-0 aspect-video w-full rounded-xl"
            }
          />
        )}

        {logo && (
          <div class="relative">
            <div class="absolute -inset-4 bg-primary/10 opacity-0 blur-2xl transition-opacity duration-500 group-hover:opacity-100" />
            <div class="relative flex size-16 items-center justify-center overflow-hidden rounded-xl border border-border/50 bg-foreground/5 transition-all duration-300 group-hover:scale-105 group-hover:border-primary/30 group-hover:bg-primary/5">
              <img alt={title || ""} class="size-full object-contain p-2" src={logo.src} />
            </div>
          </div>
        )}

        <div class:list={["flex w-full min-w-0 flex-1 flex-col", isRowLayout ? "gap-0" : "gap-4"]}>
          <div class:list={["flex w-full justify-between gap-4", isRowLayout ? "flex-row" : "flex-col sm:flex-row"]}>
            <div class:list={["flex flex-col", isRowLayout ? "gap-0" : "gap-1"]}>
              {date && (
                <div class:list={["flex items-center justify-between", !isRowLayout && "mb-1"]}>
                  <Text class="font-mono tracking-wider uppercase opacity-70" size="xs" variant="muted">
                    <FormattedDate date={date} full />
                  </Text>
                </div>
              )}

              <Heading
                class:list={[
                  "transition-colors group-hover:text-primary",
                  isRowLayout ? "mt-1 line-clamp-1" : "line-clamp-2",
                ]}
                level={headingLevel as 1 | 2 | 3 | 4 | 5 | 6}
                size={isRowLayout ? "sm" : "md"}
              >
                {title}
              </Heading>

              {subtitle && (
                <Text
                  class:list={["font-mono tracking-wider uppercase", isRowLayout ? "mt-0.5" : "mt-1"]}
                  size="xs"
                  variant="muted"
                >
                  {subtitle}
                </Text>
              )}
            </div>

            <div class:list={["flex items-center gap-2 self-start", align === "center" && !isRowLayout && "hidden"]}>
              {meta && <Badge variant="default">{meta}</Badge>}

              {url && (
                <div class="relative flex min-h-6 min-w-6 items-center justify-end font-mono">
                  <div
                    class:list={[
                      "absolute right-0 flex items-center text-muted-foreground transition-all duration-300",
                      actionLabel
                        ? "group-hover:-translate-x-2 group-hover:opacity-0"
                        : "group-hover:translate-x-1 group-hover:-translate-y-1 group-hover:text-primary",
                    ]}
                  >
                    <AppIcon name="mdi:arrow-top-right" size="sm" />
                  </div>
                  {actionLabel && (
                    <div class="flex items-center gap-1 text-[10px] font-bold tracking-widest text-primary uppercase opacity-0 transition-all duration-300 group-hover:translate-x-0 group-hover:opacity-100">
                      {actionLabel}
                      <AppIcon name={actionIcon} size="xs" />
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>

          {description && (
            <Text
              class:list={["text-muted-foreground", isRowLayout ? "mt-2 line-clamp-1" : "mt-2 line-clamp-2 flex-1"]}
              size="sm"
            >
              {description}
            </Text>
          )}

          <div class:list={["mt-auto flex items-center", isRowLayout ? "gap-2" : "w-full justify-between"]}>
            {tags && tags.length > 0 && (
              <div class:list={[isRowLayout && "mt-2"]}>
                <Tags limit={isRowLayout ? 4 : 3} tags={tags} />
              </div>
            )}

            {footerMeta && (
              <Text
                class="ml-auto font-mono tracking-wider whitespace-nowrap uppercase transition-colors group-hover:text-primary/80"
                size="xs"
                variant="muted"
              >
                {footerMeta}
              </Text>
            )}

            {icon && url && (
              <AppIcon
                class="ml-auto text-muted-foreground group-hover:text-primary"
                name="mdi:arrow-top-right"
                size="xs"
              />
            )}
          </div>
        </div>
      </div>
    </Wrapper>
  )
}

<script>
  import { initInteractiveCards } from "../../lib/dom";

  initInteractiveCards();
  document.addEventListener("astro:page-load", initInteractiveCards);
</script>
