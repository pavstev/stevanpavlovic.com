---
import type { CollectionEntry, CollectionKey } from "astro:content";

import { type CollectionItem, getViewPageProps } from "../../lib";
import LayoutContent from "../layout/layout-content.astro";
import BackButton from "../molecules/back-button.astro";
import PostToolbar from "../molecules/post-toolbar.astro";
import ZoomableImage from "../molecules/zoomable-image.astro";

interface Props {
  backLink?: string;
  collection: CollectionKey;
  entry: CollectionEntry<CollectionKey>;
}

const {
  collection,
  entry: { body, data, id },
} = Astro.props;

const item: CollectionItem<CollectionKey> = {
  body,
  collection,
  data,
  id,
};

const viewPageProps = await getViewPageProps(item);

const { backLink: defaultBackLink, description, image, tags, title, toolbarItems } = viewPageProps;

const backLink = Astro.props.backLink ? { ...defaultBackLink, href: Astro.props.backLink } : defaultBackLink;
---

<LayoutContent description={description} slug={id} title={title}>
  <Fragment slot="header">
    <div class="animate-in fade-in slide-in-from-bottom-4 duration-700">
      <div class="mb-6">
        <BackButton link={backLink} />
      </div>

      <div class="space-y-6">
        <div class="space-y-3">
          <h1
            class="text- balance text-3xl font-extrabold tracking-tighter text-foreground sm:text-4xl md:text-5xl lg:text-6xl"
          >
            {title}
          </h1>
        </div>

        <PostToolbar description={description} tags={tags} toolbarItems={toolbarItems} />
      </div>
    </div>
  </Fragment>

  <Fragment slot="hero-image">
    {
      image && (
        <div class="group animate-in fade-in zoom-in-95 fill-mode-forwards relative mb-12 w-full delay-200 duration-1000">
          <div class="relative overflow-hidden rounded-3xl border border-border/50 bg-muted shadow-2xl shadow-primary/5">
            <ZoomableImage
              alt={title}
              class="aspect-video w-full object-cover transition-transform duration-700 group-hover:scale-[1.01] md:aspect-[2.4/1]"
              height={typeof image === "string" ? undefined : image.height}
              src={typeof image === "string" ? image : image.src}
              width={typeof image === "string" ? undefined : image.width}
            />
            <div class="pointer-events-none absolute inset-0 rounded-3xl ring-1 ring-background/10 ring-inset" />

            {/* Subtle reflection/highlight overlay */}
            <div class="pointer-events-none absolute inset-0 bg-linear-to-tr from-foreground/5 to-transparent opacity-0 mix-blend-overlay transition-opacity duration-700 group-hover:opacity-100" />
          </div>
        </div>
      )
    }
  </Fragment>

  <div class="animate-in fade-in slide-in-from-bottom-8 delay-300 duration-700">
    <slot />
  </div>
</LayoutContent>
