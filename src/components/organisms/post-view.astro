---
import type { CollectionEntry } from 'astro:content';

import { PROFILE } from '../../lib/config';
import Avatar from '../atoms/avatar.astro';
import BackButton from '../atoms/back-button.astro';
import Button from '../atoms/button.astro';
import FormattedDate from '../atoms/formatted-date.astro';
import Stack from '../atoms/stack.astro';
import Text from '../atoms/text.astro';
import LayoutContent from "../layout/layout-content.astro";
import PostTags from '../molecules/post-tags.astro';
import ZoomableImage from '../molecules/zoomable-image';
import PageHero from './page-hero.astro';

type PostType = 'blog' | 'experience' | 'project';

interface Props {
  backLabel?: string;
  backLink?: string;
  data: CollectionEntry<'blog'>['data'] | CollectionEntry<'experience'>['data'] | CollectionEntry<'projects'>['data'];
  type: PostType;
}

const {
  backLabel,
  backLink,
  data,
  type,
} = Astro.props;

const defaultBackLabel = type === 'blog' ? 'Back to Blog' :
  type === 'project' ? 'Back to Projects' :
    'Back to Experience';

const defaultBackLink = type === 'blog' ? '/blog' :
  type === 'project' ? '/projects' :
    '/experience';

const finalBackLabel = backLabel || defaultBackLabel;
const finalBackLink = backLink || defaultBackLink;

const title = type === 'experience' && 'role' in data && 'company' in data
  ? `${data.role} at ${data.company}`
  : ('title' in data ? data.title : '');

const description = 'description' in data ? data.description : ('desc' in data ? data.desc : '');
---

<LayoutContent
  description={description}
  title={title}
>
  <BackButton href={finalBackLink} slot="back-link">
    {finalBackLabel}
  </BackButton>
  <PageHero description={description} slot="header" title={title}>
    <Stack align="center" class="font-mono text-xs tracking-wider uppercase" direction="row" gap={3} slot="eyebrow">
      {type === 'blog' && 'pubDate' in data && data.pubDate && (
        <FormattedDate date={data.pubDate} full />
      )}
      {type === 'project' && 'subtitle' in data && data.subtitle && (
        <Text variant="primary">{data.subtitle}</Text>
      )}
      {type === 'experience' && 'company' in data && (
        <>
          <Text variant="primary">{data.company}</Text>
          {'location' in data && data.location && <Text variant="muted">{data.location}</Text>}
        </>
      )}
    </Stack>

    {type === 'blog' && (
      <Stack align="center" direction="row" gap={3} slot="actions">
        <Avatar alt={PROFILE.name} size="sm" src={PROFILE.avatar} />
        <Stack gap={0}>
          <Text class="font-medium">{PROFILE.name}</Text>
          <Text class="text-xs" variant="muted">{PROFILE.role}</Text>
        </Stack>
      </Stack>
    )}

    {type === 'project' && (
      <Stack align="center" direction="row" gap={3} slot="actions">
        {'demoUrl' in data && data.demoUrl && (
          <Button as="a" href={data.demoUrl} variant="default">
            Live Demo
          </Button>
        )}
        {'repoUrl' in data && data.repoUrl && (
          <Button as="a" href={data.repoUrl} variant="outline">
            Source
          </Button>
        )}
      </Stack>
    )}
  </PageHero>

  {type === 'blog' && 'tags' in data && data.tags && (
    <PostTags heading="Tags" tags={data.tags} />
  )}

  {type === 'experience' && 'skills' in data && data.skills && (
    <PostTags heading="Skills" tags={data.skills} />
  )}

  {type === 'project' && 'tags' in data && data.tags && (
    <PostTags heading="Technologies" tags={data.tags} />
  )}

  {'heroImage' in data && data.heroImage && (
    <div class="relative mx-auto mb-8 aspect-video w-full max-w-3xl overflow-hidden rounded-2xl border border-foreground/10 shadow-2xl transition-all hover:border-foreground/20" slot="hero-image">
      <ZoomableImage
        alt={title}
        className="size-full object-cover"
        client:load
        height={450}
        src={data.heroImage}
        width={800}
      />
    </div>
  )}

  <slot />
</LayoutContent>
