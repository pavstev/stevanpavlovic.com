---
import { Icon } from 'astro-icon/components';
import Pagefind from "astro-pagefind/components/Search";
---

<div class="search-dropdown-container relative" id="search-container">
  {/* Search Input */}
  <div class="group/search relative flex items-center transition-all duration-300">
    <Icon class="absolute left-3 size-5 text-muted-foreground transition-colors group-focus-within/search:text-primary md:size-4" name="mdi:magnify" />
    <input
      aria-controls="search-dropdown"
      autocomplete="off"
      class="h-10 w-full min-w-[200px] rounded-full border border-white/10 bg-white/5 pr-24 pl-10 text-sm transition-all outline-none hover:bg-white/10 focus:border-primary/50 focus:bg-white/10 focus:ring-2 focus:ring-primary/20 md:h-9 md:w-48 md:min-w-0 md:pr-24 lg:w-64"
      id="search-input"
      placeholder="Search..."
      type="text"
    />
    <div class="absolute top-0 right-0 flex h-full items-center pr-1.5">
      <button
        aria-label="Clear search"
        class="search-clear mr-2 hidden size-5 items-center justify-center rounded-full bg-white/10 text-muted-foreground transition-all hover:bg-white/20 hover:text-foreground"
        id="search-clear"
        type="button"
      >
        <Icon class="size-3" name="mdi:close" />
      </button>
      <div class="mx-2 h-4 w-px bg-white/10"></div>
      <kbd class="hidden h-5 items-center gap-1 p-1 pr-2 font-mono text-[12px] font-medium opacity-70 sm:flex md:hidden lg:flex">
        <span class="text-sm">⌘</span>K
      </kbd>
    </div>
  </div>

  {/* Dropdown Menu */}
  <div
    aria-label="Search results"
    class="search-dropdown invisible absolute top-[calc(100%+0.5rem)] right-0 left-0 z-50 mx-auto w-[calc(100vw-2rem)] max-w-md opacity-0 transition-all duration-200 md:left-auto md:w-full lg:w-md"
    id="search-dropdown"
    role="menu"
  >
    <div class="overflow-hidden rounded-2xl border border-white/10 bg-background/95 shadow-2xl backdrop-blur-xl">
      {/* Search Results Area */}
      <div class="p-4">
        <Pagefind
          className="pagefind-ui"
          id="search"
          uiOptions={{
            showImages: false,
            translations: {
              placeholder: "Search..."
            }
          }}
        />
      </div>

      {/* Keyboard Shortcuts Footer */}
      <div class="flex flex-wrap items-center gap-2 border-t border-white/5 bg-white/5 px-4 py-2 text-xs font-medium text-muted-foreground md:text-[10px]">
        <span class="flex items-center gap-1">
          <kbd class="rounded bg-white/10 px-1.5 py-0.5 font-sans text-[10px]">ESC</kbd>
          close
        </span>
        <span class="flex items-center gap-1">
          <kbd class="rounded bg-white/10 px-1.5 py-0.5 font-sans text-[10px]">↑↓</kbd>
          navigate
        </span>
        <span class="flex items-center gap-1">
          <kbd class="rounded bg-white/10 px-1.5 py-0.5 font-sans text-[10px]">↵</kbd>
          select
        </span>
      </div>
    </div>
  </div>
</div>

<script>
  import { initSearchDropdown } from '../../lib/search';

  initSearchDropdown();
  document.addEventListener('astro:page-load', initSearchDropdown);
</script>

<style is:global>
  /* Search dropdown visible state */
  .search-dropdown.visible {
    visibility: visible;
    opacity: 1;
  }

  /* Show clear button when input has value */
  .search-clear.visible {
    display: flex !important;
  }

  /* Pagefind UI customization */
  .search-dropdown .pagefind-ui {
    width: 100% !important;
    --pagefind-ui-background: transparent !important;
  }

  /* Hide the Pagefind search input since we're using the header input */
  .search-dropdown .pagefind-ui__search-input {
    display: none !important;
  }

  /* Hide the search form wrapper */
  .search-dropdown .pagefind-ui__form {
    display: none !important;
  }

  .search-dropdown .pagefind-ui__drawer {
    width: 100% !important;
    max-height: 60vh !important;
    overflow-y: auto !important;
    margin-top: 0 !important;
  }

  .search-dropdown .pagefind-ui__results {
    width: 100% !important;
  }

  /* Custom scrollbar for results */
  .search-dropdown .pagefind-ui__drawer::-webkit-scrollbar {
    width: 6px;
  }

  .search-dropdown .pagefind-ui__drawer::-webkit-scrollbar-track {
    background: transparent;
  }

  .search-dropdown .pagefind-ui__drawer::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
  }

  .search-dropdown .pagefind-ui__drawer::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  /* Hide pagefind branding if present */
  .search-dropdown .pagefind-ui__brand {
    display: none !important;
  }
</style>
