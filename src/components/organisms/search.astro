---
import { Icon } from 'astro-icon/components';
import Pagefind from "astro-pagefind/components/Search";

import Modal from '../atoms/modal.astro';
---

<div class="search-wrapper group relative flex items-center">
  {/* Search Trigger */}
  <button
    aria-label="Search"
    class="flex size-9 items-center justify-center rounded-full text-muted-foreground transition-all duration-300 hover:scale-110 hover:bg-white/10 hover:text-foreground active:scale-95"
    id="search-trigger"
    type="button"
  >
    <Icon name="mdi:magnify" size={20} />
  </button>

  <Modal class="w-full max-w-2xl" id="search-modal">
    <div class="space-y-4">
      <Pagefind
        className="pagefind-ui"
        id="search"
        uiOptions={{
          showImages: false,
          translations: {
            placeholder: "Search documentation, posts, projects..."
          }
        }}
      />

      <div class="flex items-center gap-4 border-t border-white/10 pt-4 text-[10px] font-medium text-muted-foreground">
        <span class="flex items-center gap-1"><kbd class="rounded bg-white/10 px-1 py-0.5 font-sans text-muted-foreground">ESC</kbd> to close</span>
        <span class="flex items-center gap-1"><kbd class="rounded bg-white/10 px-1 py-0.5 font-sans text-muted-foreground">↑↓</kbd> to navigate</span>
        <span class="flex items-center gap-1"><kbd class="rounded bg-white/10 px-1 py-0.5 font-sans text-muted-foreground">↵</kbd> to select</span>
      </div>
    </div>
  </Modal>
</div>

<script>
  function initSearch() {
    const trigger = document.getElementById('search-trigger');
    const modal = document.getElementById('search-modal') as HTMLDialogElement;

    if (!trigger || !modal) return;

    trigger.addEventListener('click', () => {
      modal.showModal();
      // Focus input after modal opens
      setTimeout(() => {
         const input = modal.querySelector('input');
         if (input) input.focus();
      }, 50);
    });

    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.key === '/' && !modal.open && !(e.target instanceof HTMLInputElement) && !(e.target instanceof HTMLTextAreaElement)) {
            e.preventDefault();
            modal.showModal();
            setTimeout(() => {
               const input = modal.querySelector('input');
               if (input) input.focus();
            }, 50);
        }
        if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
            e.preventDefault();
            if (modal.open) {
              modal.close();
            } else {
              modal.showModal();
              setTimeout(() => {
                 const input = modal.querySelector('input');
                 if (input) input.focus();
              }, 50);
            }
        }
    });
  }

  initSearch();
  document.addEventListener('astro:page-load', initSearch);
</script>


