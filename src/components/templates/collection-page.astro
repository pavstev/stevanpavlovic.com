---
import type { CollectionKey } from "astro:content";

import type { CollectionItem } from "../../lib";
import type { DisplayMode } from "../../lib/list";

import Stack from "../atoms/stack.astro";
import Text from "../atoms/text.astro";
import LayoutRoot from "../layout/layout-root.astro";
import ListActions from "../molecules/list-actions.astro";
import MasonryGrid from "../molecules/masonry-grid.astro";
import Card from "../organisms/card.astro";
import CollectionHeader from "../organisms/collection-header.astro";
import Section from "../organisms/section.astro";

interface Props {
  baseUrl: string;
  // Data
  collectionItems: CollectionItem<CollectionKey>[]; // The collection items
  // Script configuration
  collectionKey: CollectionKey;
  containerId: string;
  currentPage?: number;

  description: string;
  // Configuration
  display: DisplayMode;

  displayUrls?: { grid: string; list: string };
  // Helpers to map generic items to Card props
  // eslint-disable-next-line no-unused-vars
  getItemCardProps: (item: any) => any;
  headerDescription: string;
  headerIcon: string;
  headerTitle: string;
  initialPageSize?: number;
  nextUrl?: string;
  prevUrl?: string;

  title: string;

  totalItems: number;
  totalPages?: number;
}

const {
  baseUrl,
  collectionItems: items,
  collectionKey,
  containerId,
  currentPage = 1,
  description,
  display,
  displayUrls,
  getItemCardProps,
  headerDescription,
  headerIcon,
  headerTitle,
  initialPageSize = 6,
  nextUrl,
  prevUrl,
  title,
  totalPages = 1,
} = Astro.props;

// Determine if we should show List or Grid
const isList = display === "list";
const isGrid = display === "grid";
---

<LayoutRoot description={description} slug={`/${collectionKey}/${display}`} title={title}>
  <Section>
    <CollectionHeader description={headerDescription} icon={headerIcon} level={2} title={headerTitle}>
      <ListActions
        baseUrl={baseUrl}
        currentPage={currentPage}
        display={display}
        displayUrls={displayUrls}
        getPageUrl={(p) => (p === 1 ? `${baseUrl}/${display}` : `${baseUrl}/${display}/${p}`)}
        nextUrl={nextUrl}
        paginationType="path"
        prevUrl={prevUrl}
        totalPages={totalPages}
      />
    </CollectionHeader>

    <Stack gap={4}>
      <div class="view-container" data-initial-page-size={initialPageSize} id={containerId}>
        {/* VIEW MODE: LIST */}
        {
          isList && (
            <div class="list-view flex flex-col gap-3 transition-opacity duration-300 sm:gap-4">
              {items.map((item) => (
                <div class="card-item transition-all duration-300">
                  <Card list {...getItemCardProps(item)} />
                </div>
              ))}
            </div>
          )
        }

        {/* VIEW MODE: GRID */}
        {
          isGrid && (
            <div class="grid-view transition-opacity duration-300">
              <MasonryGrid columns={2}>
                {items.map((item) => (
                  <div class="masonry-item card-item transition-all duration-300">
                    <Card {...getItemCardProps(item)} />
                  </div>
                ))}
              </MasonryGrid>
            </div>
          )
        }

        {/* No Results */}
        <div class="mt-12 hidden text-center text-muted-foreground" id="no-results">
          <div class="flex flex-col items-center justify-center gap-2">
            <span class="text-4xl">üîç</span>
            <Text class="font-medium" size="lg">No results found.</Text>
            <a
              class="mt-4 rounded-full bg-secondary/10 px-4 py-2 text-sm font-semibold text-secondary transition-colors hover:bg-secondary/20"
              href={baseUrl}
            >
              Clear Filters
            </a>
          </div>
        </div>
      </div>
    </Stack>
  </Section>
</LayoutRoot>

<script>
  import { initInteractiveCards } from "../../lib/interactive-cards";

  const setup = () => {
    initInteractiveCards();
  };

  setup();
  document.addEventListener("astro:page-load", setup);
</script>
