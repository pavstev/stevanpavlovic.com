---
import type { BentoItem } from "@components/custom/bento/bento-types";

import { BentoGrid } from "@components/custom/bento/bento-grid";
import { CollectionPagination } from "@components/custom/navigation/collection-pagination";
import PageLayout from "@components/layout/page-layout.astro";
import { getCollection, getEntries } from "astro:content";
import { ITEMS_PER_PAGE, NAV_ITEMS, SITE_CONFIG } from "src/constants";

interface Props {
  page?: number | string;
}

const { page = 1 } = Astro.props;
const currentPage = typeof page === "string" ? parseInt(page, 10) : page;

const allEntries = await getCollection("projects");

const totalItems = allEntries.length;
const totalPages = Math.max(1, Math.ceil(totalItems / ITEMS_PER_PAGE));
const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
const endIndex = startIndex + ITEMS_PER_PAGE;
const pageEntries = allEntries.slice(startIndex, endIndex);

const bentoItems: BentoItem[] = await Promise.all(
  pageEntries.map(async (entry) => {
    const tags = entry.data.tags?.length
      ? await getEntries(entry.data.tags).then((t) =>
          t.filter((x) => !!x).map((x) => x.data.label || x.data.id)
        )
      : [];

    const image = entry.data.image;
    const imageSrc =
      typeof image === "object" && image !== null && "src" in image
        ? image.src
        : (image as string | undefined);

    return {
      className: "col-span-1",
      cta: "View details",
      description: entry.data.description ?? "",
      href: `/projects/${entry.id}`,
      id: entry.id,
      image: imageSrc,
      tags,
      tagsVariant: "default",
      title: entry.data.title ?? entry.id,
    };
  })
);

const baseUrl = "/projects";
const prevUrl =
  currentPage > 1 ? (currentPage === 2 ? baseUrl : `${baseUrl}/${currentPage - 1}`) : undefined;
const nextUrl = currentPage < totalPages ? `${baseUrl}/${currentPage + 1}` : undefined;

const navConfig = NAV_ITEMS.projects;
const title = currentPage === 1 ? navConfig.label : `${navConfig.label} - Page ${currentPage}`;
const description = `${SITE_CONFIG.author} - ${navConfig.label}`;
---

<PageLayout
  description={description}
  slug={currentPage === 1 ? "/projects" : `/projects/${currentPage}`}
  {title}
>
  <div class="px-6 py-12 md:px-12">
    <div class="flex flex-col gap-12">
      <BentoGrid className="py-0 sm:py-0" client:visible items={bentoItems} />

      <CollectionPagination
        baseUrl={baseUrl}
        currentPage={currentPage}
        nextUrl={nextUrl}
        prevUrl={prevUrl}
        totalPages={totalPages}
      />
    </div>
  </div>
</PageLayout>
