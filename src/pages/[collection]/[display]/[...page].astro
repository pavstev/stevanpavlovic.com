---
// Handles: /blog/grid/2, /blog/list/3, etc. (explicit display, pages 2+)
import type { GetStaticPaths } from "astro";

import CollectionPage from "../../../components/templates/collection-page.astro";
import { collections } from "../../../content.config";
import {
  buildDisplayUrls,
  buildPaginationUrls,
  type CollectionName,
  type DisplayMode,
  getCollectionConfig,
  getCollectionData,
  getItemCardProps,
  getPageItems,
  ITEMS_PER_PAGE,
} from "../../../lib/collection-pages";
import { type Params as BaseParams } from "./../[display].astro";

interface Params extends BaseParams {
  page: `${number}`;
}

export const prerender = true;

export const getStaticPaths: GetStaticPaths = async () => {
  const displays: DisplayMode[] = ["list", "grid"];
  const paths: Array<{
    params: {
      collection: CollectionName;
      display: DisplayMode;
      page: string;
    };
  }> = [];

  const collectionNames = Object.keys(collections) as CollectionName[];
  for (const collection of collectionNames) {
    const sortedItems = await getCollectionData(collection);
    const totalItems = sortedItems.length;
    const totalPages = Math.max(1, Math.ceil(totalItems / ITEMS_PER_PAGE));

    for (const display of displays) {
      // Start from page 2 since page 1 is handled by [display].astro
      for (let pageNum = 2; pageNum <= totalPages; pageNum++) {
        paths.push({
          params: {
            collection,
            display,
            page: String(pageNum),
          },
        });
      }
    }
  }

  return paths;
};

const { collection, display, page } = Astro.params as unknown as Params;
const currentPage = parseInt(page, 10);

const sortedItems = await getCollectionData(collection);
const totalItems = sortedItems.length;
const totalPages = Math.max(1, Math.ceil(totalItems / ITEMS_PER_PAGE));
const items = getPageItems(sortedItems, currentPage);

const config = getCollectionConfig(collection);
const baseUrl = `/${collection}`;
const displayUrls = buildDisplayUrls(collection, currentPage);
const { nextUrl, prevUrl } = buildPaginationUrls(collection, display, currentPage, totalPages);
---

<CollectionPage
  {...config}
  baseUrl={baseUrl}
  containerId={`${collection}-container`}
  currentPage={currentPage}
  display={display}
  displayUrls={displayUrls}
  getItemCardProps={(item) => getItemCardProps(item)}
  initialPageSize={20}
  collectionItems={items}
  nextUrl={nextUrl}
  prevUrl={prevUrl}
  totalItems={totalItems}
  totalPages={totalPages}
/>
