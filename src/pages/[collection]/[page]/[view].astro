---
import { getCollection } from 'astro:content';

import CollectionPage from '../../../components/templates/collection-page.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../../consts';
import { PROFILE } from '../../../lib/config';

export const prerender = true;

// Type Definitions
type CollectionItem = {
  data: any;
  id: string;
};

type CollectionName = 'blog' | 'experience' | 'projects';

// Generate static paths for all collection pages
export async function getStaticPaths() {
  const ITEMS_PER_PAGE = 10;
  const collections: CollectionName[] = ['blog', 'projects', 'experience'];
  const views = ['list', 'grid'] as const;
  const paths = [];

  for (const collectionName of collections) {
    // Fetch all items for this collection
    const allItems = await getCollection(collectionName) as CollectionItem[];

    // Sort by newest first (default)
    const sortedItems = allItems.sort((a, b) => {
      const getItemDate = (item: CollectionItem): number => {
        if (collectionName === 'blog' || collectionName === 'projects') {
          return item.data.pubDate ? new Date(item.data.pubDate).getTime() : 0;
        }
        // experience
        return item.data.startDate ? new Date(item.data.startDate).getTime() : 0;
      };

      return getItemDate(b) - getItemDate(a);
    });

    const totalItems = sortedItems.length;
    const totalPages = Math.max(1, Math.ceil(totalItems / ITEMS_PER_PAGE));

    // Generate paths for each page and view combination
    for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
      for (const view of views) {
        const startIndex = (pageNum - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;
        const pageItems = sortedItems.slice(startIndex, endIndex);

        paths.push({
          params: {
            collection: collectionName,
            page: pageNum.toString(),
            view,
          },
          props: {
            collection: collectionName,
            currentPage: pageNum,
            items: pageItems,
            totalItems,
            totalPages,
            view,
          },
        });
      }
    }
  }

  return paths;
}

const { collection, currentPage, items, totalItems, totalPages, view } = Astro.props;

// --- Collection Specific Configuration ---

// 1. Title & Description
let title = '';
let description = '';
let headerTitle = '';
let headerDescription = '';
let headerIcon = '';
let baseUrl = `/${collection}`;

if (collection === 'blog') {
  title = `Blog | ${SITE_TITLE}`;
  description = SITE_DESCRIPTION;
  headerTitle = 'Blog Posts';
  headerDescription = "Thoughts and tutorials on software engineering.";
  headerIcon = "mdi:newspaper-variant-outline";
} else if (collection === 'projects') {
  title = `Projects | ${PROFILE.name}`;
  description = `${PROFILE.name} - Projects & Portfolio`;
  headerTitle = 'Projects';
  headerDescription = "A collection of open-source libraries, applications, and experiments I've built.";
  headerIcon = "mdi:console";
} else if (collection === 'experience') {
  title = `Experience | ${PROFILE.name}`;
  description = `${PROFILE.name} - Work Experience`;
  headerTitle = 'Experience';
  headerDescription = "My professional journey and career highlights.";
  headerIcon = "mdi:briefcase-outline";
}

// 2. Item Props Helpers
const getItemCardProps = (item: any) => {
  if (collection === 'blog') {
    return { post: item, variant: 'content' };
  }
  if (collection === 'projects') {
    return {
      portfolioItem: {
        desc: item.data.description,
        href: `/projects/view/${item.id}`,
        id: item.id,
        meta: item.data.pubDate ? new Date(item.data.pubDate).getFullYear().toString() : '',
        subtitle: item.data.subtitle,
        tags: item.data.tags,
        title: item.data.title,
      },
      variant: 'portfolio'
    };
  }
  if (collection === 'experience') {
    return {
      portfolioItem: {
        company: item.data.company,
        desc: item.data.description,
        endDate: item.data.endDate,
        href: `/experience/view/${item.id}`,
        id: item.id,
        location: item.data.location,
        logo: item.data.logo,
        meta: `${new Date(item.data.startDate).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })} â€” ${item.data.endDate ? new Date(item.data.endDate).toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) : 'Present'}`,
        role: item.data.role,
        startDate: item.data.startDate,
        subtitle: item.data.company,
        tags: item.data.skills,
        title: item.data.role,
      },
      variant: 'portfolio'
    };
  }
  return {};
};

const viewUrls = {
  grid: `/${collection}/${currentPage}/grid`,
  list: `/${collection}/${currentPage}/list`,
};

const prevUrl = currentPage > 1 ? `/${collection}/${currentPage - 1}/${view}` : undefined;
const nextUrl = currentPage < totalPages ? `/${collection}/${currentPage + 1}/${view}` : undefined;

---

<CollectionPage
  baseUrl={baseUrl}
  containerId={`${collection}-container`}
  currentPage={currentPage}
  description={description}
  getItemCardProps={getItemCardProps}
  headerDescription={headerDescription}
  headerIcon={headerIcon}
  headerTitle={headerTitle}
  initialPageSize={20}
  items={items}
  nextUrl={nextUrl}
  prevUrl={prevUrl}
  title={title}
  totalItems={totalItems}
  totalPages={totalPages}
  viewMode={view}
  viewUrls={viewUrls}
/>
