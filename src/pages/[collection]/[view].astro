---
// Handles: /blog/grid, /blog/list, /projects/grid, etc. (explicit view, page 1)
import type { GetStaticPaths } from 'astro';

import CollectionPage from '../../components/templates/collection-page.astro';
import {
  buildPaginationUrls,
  buildViewUrls,
  type CollectionName,
  getCollectionConfig,
  getCollectionData,
  getItemCardProps,
  getPageItems,
  ITEMS_PER_PAGE,
  type ViewMode,
} from '../../lib/collection-pages';

export const prerender = true;

export const getStaticPaths: GetStaticPaths = async () => {
  const collections: CollectionName[] = ['blog', 'projects', 'experience'];
  const views: ViewMode[] = ['list', 'grid'];
  const paths: Array<{
    params: {
      collection: CollectionName;
      view: ViewMode;
    };
  }> = [];

  for (const collection of collections) {
    for (const view of views) {
      paths.push({
        params: { collection, view },
      });
    }
  }

  return paths;
};

const { collection, view } = Astro.params;
const currentPage = 1;

const sortedItems = await getCollectionData(collection);
const totalItems = sortedItems.length;
const totalPages = Math.max(1, Math.ceil(totalItems / ITEMS_PER_PAGE));
const items = getPageItems(sortedItems, currentPage);

const config = getCollectionConfig(collection);
const baseUrl = `/${collection}`;
const viewUrls = buildViewUrls(collection, currentPage);
const { nextUrl, prevUrl } = buildPaginationUrls(collection, view, currentPage, totalPages);
---

<CollectionPage
  {...config}
  baseUrl={baseUrl}
  containerId={`${collection}-container`}
  currentPage={currentPage}
  getItemCardProps={(item) => getItemCardProps(collection, item)}
  initialPageSize={20}
  items={items}
  nextUrl={nextUrl}
  prevUrl={prevUrl}
  totalItems={totalItems}
  totalPages={totalPages}
  viewMode={view}
  viewUrls={viewUrls}
/>
