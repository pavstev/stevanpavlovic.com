---
import type { GetStaticPathsItem, GetStaticPathsResult } from "astro";
import type { CollectionEntry } from "astro:content";

import { getCollection, render } from "astro:content";

import type { CollectionName } from "../../../lib/collection-pages";
import type { Params as BaseParams } from "./../index.astro";

import PostView from "../../../components/organisms/post-view.astro";
import { collections } from "../../../lib/collection-pages";

export const prerender = true;

interface Params extends BaseParams {
  slug: string;
}

type Props = CollectionEntry<CollectionName>;

export async function getStaticPaths(): Promise<GetStaticPathsResult> {
  const result = await Promise.all(
    collections.map(async (collection): Promise<GetStaticPathsItem[]> => {
      const items = await getCollection(collection);

      return items.map((item): GetStaticPathsItem => {
        const { collection, id: slug } = item;
        return {
          params: { collection, slug },
          props: item,
        };
      });
    }),
  );

  return result.flat();
}

const { collection } = Astro.params as unknown as Params;
const entry = Astro.props as Props;

if (entry === undefined) {
  return Astro.redirect("/404");
}

const { Content } = await render(entry);
---

<PostView collection={collection} entry={entry}>
  <Content />
</PostView>
