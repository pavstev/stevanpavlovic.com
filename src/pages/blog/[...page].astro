---
import type { GetStaticPaths } from 'astro';

import { getCollection } from 'astro:content';

import Stack from '../../components/atoms/stack.astro';
import LayoutRoot from '../../components/layout/layout-root.astro';
import ListActions, { type FilterConfig } from '../../components/molecules/list-actions.astro';
import MasonryGrid from '../../components/molecules/masonry-grid.astro';
import Card from '../../components/organisms/card.astro';
import SectionHeader from "../../components/organisms/section-header.astro";
import Section from "../../components/organisms/section.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';
import { sortPosts } from '../../lib/cms';

export const prerender = true;

export const getStaticPaths = (async ({ paginate }) => {
  const allPosts = await getCollection('blog');
  const sortedPosts = sortPosts(allPosts);

  // Load ALL posts into one page for client-side control
  return paginate(sortedPosts, { pageSize: 1000 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;

// Client-side state defaults
const allTags = [...new Set(page.data.flatMap(post => post.data.tags || []))].sort();
const INITIAL_PAGE_SIZE = 8; // Default for blog grid

// Logic Helpers for data attributes
const getPostDate = (data: any) => data.pubDate ? new Date(data.pubDate).getTime() : 0;

const sortOptions = [
  { href: '?sort=newest', label: 'Newest First', value: 'newest' },
  { href: '?sort=oldest', label: 'Oldest First', value: 'oldest' },
  { href: '?sort=a-z', label: 'A-Z', value: 'a-z' },
];

const tagOptions = [
  { href: '?', label: 'All Tags', value: '' },
  ...allTags.map(tag => ({
    href: `?filter=${tag}`,
    label: tag.charAt(0).toUpperCase() + tag.slice(1),
    value: tag,
  })),
];

const filters: FilterConfig[] = [
  { id: 'sort', label: 'Sort', options: sortOptions, selectedValue: 'newest' },
  ...(allTags.length > 0 ? [{ id: 'filter', label: 'Tag', options: tagOptions, selectedValue: '' }] : []),
];
---

<LayoutRoot description={SITE_DESCRIPTION} title={`Blog | ${SITE_TITLE}`}>
  <Section>
    <SectionHeader
      class="mb-8"
      description="Thoughts and tutorials on software engineering."
      icon="mdi:newspaper-variant-outline"
      title="Blog Posts"
    />

    <Stack gap={6}>
      <ListActions
        baseUrl="/blog"
        currentPage={1}
        filters={filters}
        itemCountLabel="posts"
        itemsPerPage={INITIAL_PAGE_SIZE}
        paginationType="query"
        showItemCount
        showItemsPerPage={true}
        showViewToggle
        totalItems={page.total}
        totalPages={1}
        viewMode="grid"
      />

      <div class="blog-view-list min-h-[50vh]" id="blog-container">

        {/* LIST VIEW (Initially Hidden if default is Grid) */}
        <div class="list-view hidden flex flex-col gap-3 sm:gap-4 transition-opacity duration-300">
          {page.data.map((post, index) => (
            <div
              class:list={['list-item transition-all duration-300', { hidden: index >= INITIAL_PAGE_SIZE }]}
              data-date={getPostDate(post.data)}
              data-tags={post.data.tags?.join(',') || ''}
              data-title={post.data.title}
            >
              <Card list post={post} variant="content" />
            </div>
          ))}
        </div>

        {/* GRID VIEW (Default) */}
        <div class="grid-view transition-opacity duration-300">
          <MasonryGrid columns={2}>
            {page.data.map((post, index) => (
              <div
                class:list={['masonry-item list-item transition-all duration-300', { hidden: index >= INITIAL_PAGE_SIZE }]}
                data-date={getPostDate(post.data)}
                data-tags={post.data.tags?.join(',') || ''}
                data-title={post.data.title}
              >
                <Card post={post} variant="content" />
              </div>
            ))}
          </MasonryGrid>
        </div>

        <div class="mt-12 hidden text-center text-gray-500" id="no-results">
           <div class="flex flex-col items-center justify-center gap-2">
             <span class="text-4xl">üîç</span>
             <p class="text-lg font-medium">No posts found.</p>
             <a class="mt-4 rounded-full bg-secondary/10 px-4 py-2 text-sm font-semibold text-secondary transition-colors hover:bg-secondary/20" href="/blog">
                Clear Filters
             </a>
           </div>
        </div>

      </div>
    </Stack>
  </Section>
</LayoutRoot>

<style is:global>
  .hidden { display: none !important; }
</style>

<script>
  import { ClientList } from '../../lib/client-list';
  import { initInteractiveCards } from '../../lib/interactive-cards';

  initInteractiveCards();

  document.addEventListener('astro:page-load', () => {
    initInteractiveCards();

    new ClientList({
      containerId: 'blog-container',
      initialPageSize: 8,
      ui: {
        itemSelector: '.list-item'
      }
    });
  });
</script>
