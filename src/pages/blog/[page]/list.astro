---
import type { GetStaticPaths } from 'astro';
import { getCollection } from 'astro:content';
import CollectionPage from '../../../components/templates/collection-page.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../../consts';
import { sortPosts } from '../../../lib/cms';

export const prerender = true;

export const getStaticPaths = (async ({ paginate }) => {
  const allPosts = await getCollection('blog');
  const sortedPosts = sortPosts(allPosts);
  return paginate(sortedPosts, { pageSize: 1000 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;
const allTags = [...new Set(page.data.flatMap((post: any) => post.data.tags || []))].sort();

const sortOptions = [
  { href: '?sort=newest', label: 'Newest First', value: 'newest' },
  { href: '?sort=oldest', label: 'Oldest First', value: 'oldest' },
  { href: '?sort=a-z', label: 'A-Z', value: 'a-z' },
];

const tagOptions = [
  { href: '?', label: 'All Tags', value: '' },
  ...allTags.map((tag: string) => ({
    href: `?filter=${tag}`,
    label: tag.charAt(0).toUpperCase() + tag.slice(1),
    value: tag,
  })),
];

const filters = [
  { id: 'sort', label: 'Sort', options: sortOptions, selectedValue: 'newest' },
  ...(allTags.length > 0 ? [{ id: 'filter', label: 'Tag', options: tagOptions, selectedValue: '' }] : []),
];

// Helpers
const getItemDate = (post: any) => post.data.pubDate ? new Date(post.data.pubDate).getTime() : 0;
const getItemTags = (post: any) => post.data.tags || [];
const getItemCardProps = (post: any) => ({ post, variant: 'content' });
---

<CollectionPage
  baseUrl="/blog"
  containerId="blog-container"
  description={SITE_DESCRIPTION}
  filters={filters}
  getItemCardProps={getItemCardProps}
  getItemDate={getItemDate}
  getItemTags={getItemTags}
  headerDescription="Thoughts and tutorials on software engineering."
  headerIcon="mdi:newspaper-variant-outline"
  headerTitle="Blog Posts"
  initialPageSize={8}
  items={page.data}
  title={`Blog | ${SITE_TITLE}`}
  totalItems={page.total}
  viewMode="list"
/>
