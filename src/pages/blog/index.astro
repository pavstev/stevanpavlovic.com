---
import { getCollection } from 'astro:content';

export const prerender = false;

import LayoutRoot from '../../components/layout/layout-root.astro';
import Card from '../../components/molecules/card.astro';
import Empty from '../../components/molecules/empty.astro';
import FilterBar from '../../components/molecules/filter-bar.astro';
import MasonryGrid from '../../components/molecules/masonry-grid.astro';
import SectionHeader from "../../components/organisms/section-header.astro";
import Section from "../../components/organisms/section.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';
import { filterPosts, getPagination, getUniqueTags, sortPosts } from '../../lib/cms';
import { formatFilterLabel } from '../../lib/text';

// Get params
const pageParam = Astro.url.searchParams.get('page');
const filterParam = Astro.url.searchParams.get('filter');
const sortParam = Astro.url.searchParams.get('sort') || 'newest';

// Get all posts and process them
const allPosts = await getCollection('blog');
const tags = getUniqueTags(allPosts);
const filters = tags.map(tag => ({ label: formatFilterLabel(tag), value: tag.toLowerCase() }));

let filteredPosts = filterPosts(allPosts, filterParam);
filteredPosts = sortPosts(filteredPosts, sortParam);

const { currentPage, nextUrl, paginatedItems: paginatedPosts, prevUrl, totalPages } = getPagination(
  filteredPosts,
  pageParam,
  9,
  '/blog',
  Astro.url.searchParams
);
---

<LayoutRoot description={SITE_DESCRIPTION} title={`Blog | ${SITE_TITLE}`}>
  <Section>
    <SectionHeader
      description="Thoughts, tutorials, and deep dives into software engineering and architecture."
      icon="mdi:newspaper-variant-outline"
      id="blog-heading"
      title="Blog Posts"
    />

    <FilterBar
      activeFilter={filterParam || 'all'}
      activeSort={sortParam}
      baseUrl="/blog"
      filters={filters}
      pagination={{
        currentPage,
        nextUrl,
        prevUrl,
        totalPages
      }}
    />

    {paginatedPosts.length > 0 ? (
      <MasonryGrid class="mt-8">
        {
          paginatedPosts.map((post, index) => (
            <div class="masonry-item">
              <Card
                loading={currentPage === 1 && index === 0 ? 'eager' : 'lazy'}
                post={post}
                variant="content"
              />
            </div>
          ))
        }
      </MasonryGrid>
    ) : (
      <Empty
        action={
          filterParam
            ? { href: '/blog', label: 'Clear Filter' }
            : undefined
        }
        description={
          filterParam
            ? `No posts found with tag "${filterParam}". Try clearing the filter.`
            : "We couldn't find any posts at the moment. Check back later!"
        }
        icon="mdi:newspaper-variant-outline"
        title="No posts found"
      />
    )
    }
  </Section>
</LayoutRoot>
