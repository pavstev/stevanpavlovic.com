---
import { getCollection } from 'astro:content';

export const prerender = false;

import LayoutRoot from '../../components/layout/layout-root.astro';
import Empty from '../../components/molecules/empty.astro';
import MasonryGrid from '../../components/molecules/masonry-grid.astro';
import Pagination from '../../components/molecules/pagination.astro';
import Card from '../../components/organisms/card.astro';
import SectionHeader from "../../components/organisms/section-header.astro";
import Section from "../../components/organisms/section.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';
import { filterPosts, getPagination, sortPosts } from '../../lib/cms';

const pageParam = Astro.url.searchParams.get('page');
const filterParam = Astro.url.searchParams.get('filter');
const sortParam = Astro.url.searchParams.get('sort') || 'newest';

const allPosts = await getCollection('blog');
const filteredPosts = filterPosts(allPosts, filterParam);
const sortedPosts = sortPosts(filteredPosts, sortParam);

const { currentPage, nextUrl, paginatedItems, prevUrl, totalPages } = getPagination(
  sortedPosts,
  pageParam,
  9,
  '/blog',
  Astro.url.searchParams
);
---

<LayoutRoot description={SITE_DESCRIPTION} title={`Blog | ${SITE_TITLE}`}>
  <Section>
    <SectionHeader
      description="Thoughts and tutorials on software engineering."
      title="Blog Posts"
    />

    {
      paginatedItems.length > 0 ? (
        <>
          <MasonryGrid>
            {
              paginatedItems.map((post) => (
                <div class="masonry-item">
                  <Card post={post} variant="content" />
                </div>
              ))
            }
          </MasonryGrid>

          {totalPages > 1 && (
            <Pagination
              baseUrl="/blog"
              currentPage={currentPage}
              totalPages={totalPages}
            />
          )}
        </>
      ) : (
        <Empty
          action={filterParam ? { href: '/blog', label: 'Clear Filter' } : undefined}
          description={filterParam ? `No posts found with tag "${filterParam}".` : "No posts yet."}
          title="No posts found"
        />
      )
    }
  </Section>
</LayoutRoot>
