---
import { getCollection } from 'astro:content';

export const prerender = false;

import Stack from '../../components/atoms/stack.astro';
import LayoutRoot from '../../components/layout/layout-root.astro';
import Empty from '../../components/molecules/empty.astro';
import ListActions, { type FilterConfig, type ViewMode } from '../../components/molecules/list-actions.astro';
import MasonryGrid from '../../components/molecules/masonry-grid.astro';
import Card from '../../components/organisms/card.astro';
import SectionHeader from "../../components/organisms/section-header.astro";
import Section from "../../components/organisms/section.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';
import { getPagination, sortPosts } from '../../lib/cms';

// Get URL params
const pageParam = Astro.url.searchParams.get('page');
const filterParam = Astro.url.searchParams.get('filter');
const sortParam = Astro.url.searchParams.get('sort') || 'newest';
const viewParam = (Astro.url.searchParams.get('view') as ViewMode) || 'masonry-3';

// Parse multi-select filters (comma-separated)
const selectedFilters = filterParam ? filterParam.split(',').filter(Boolean) : [];

// Get and process posts
const allPosts = await getCollection('blog');

// Filter posts - must have ALL selected tags
const filteredPosts = selectedFilters.length > 0
  ? allPosts.filter(post =>
    selectedFilters.every(filter =>
      post.data.tags?.some(tag => tag.toLowerCase() === filter.toLowerCase())
    )
  )
  : allPosts;

const sortedPosts = sortPosts(filteredPosts, sortParam);

// Get unique tags for filter dropdown
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags || []))].sort();

// Pagination
const { currentPage, paginatedItems, totalPages } = getPagination(
  sortedPosts,
  pageParam,
  viewParam === 'list' ? 10 : viewParam === 'masonry-2' ? 8 : 9,
  '/blog',
  Astro.url.searchParams
);

// Build multi-select filter URLs
function buildFilterUrl(tag: string): string {
  const newFilters = selectedFilters.includes(tag)
    ? selectedFilters.filter(f => f !== tag)
    : [...selectedFilters, tag];

  return buildUrl('/blog', {
    filter: newFilters.length > 0 ? newFilters.join(',') : undefined,
    sort: sortParam !== 'newest' ? sortParam : undefined
  });
}

// Helper to build URLs with params
function buildUrl(base: string, params: Record<string, string | undefined>) {
  const url = new URL(base, 'http://localhost');
  Object.entries(params).forEach(([key, value]) => {
    if (value && value !== 'newest') {
      url.searchParams.set(key, value);
    }
  });
  return url.pathname + url.search;
}

// Build sort URLs (preserve current filters)
const sortOptions = [
  { href: buildUrl('/blog', { filter: filterParam || undefined, sort: 'newest' }), label: 'Newest First', value: 'newest' },
  { href: buildUrl('/blog', { filter: filterParam || undefined, sort: 'oldest' }), label: 'Oldest First', value: 'oldest' },
  { href: buildUrl('/blog', { filter: filterParam || undefined, sort: 'a-z' }), label: 'A-Z', value: 'a-z' },
  { href: buildUrl('/blog', { filter: filterParam || undefined, sort: 'z-a' }), label: 'Z-A', value: 'z-a' },
];

// Tag options with checkmarks for selected
const tagOptions: { href: string; label: string; value: string; }[] = [
  { href: buildUrl('/blog', { sort: sortParam !== 'newest' ? sortParam : undefined }), label: 'All Tags', value: '' },
  ...allTags.map(tag => ({
    href: buildFilterUrl(tag),
    label: tag.charAt(0).toUpperCase() + tag.slice(1),
    value: tag,
  })),
];

const filters: FilterConfig[] = [
  {
    id: 'sort',
    label: 'Sort',
    options: sortOptions,
    selectedValue: sortParam,
  },
  ...(allTags.length > 0 ? [{
    id: 'filter',
    label: selectedFilters.length > 0 ? `Tags (${selectedFilters.length})` : 'Filter',
    options: tagOptions,
    selectedValues: selectedFilters,
  }] : []),
];

// Build base URL for pagination (preserves filter and sort)
const baseUrl = buildUrl('/blog', { filter: filterParam || undefined, sort: sortParam !== 'newest' ? sortParam : undefined });

// Reset URL - keeps sort but clears filters
const resetUrl = buildUrl('/blog', { sort: sortParam !== 'newest' ? sortParam : undefined });
---

<LayoutRoot description={SITE_DESCRIPTION} title={`Blog | ${SITE_TITLE}`}>
  <Section>
    <SectionHeader
      class="mb-8 px-0 sm:px-0 lg:px-0"
      description="Thoughts and tutorials on software engineering."
      icon="mdi:newspaper-variant-outline"
      title="Blog Posts"
    />

    {
      paginatedItems.length > 0 ? (
        <Stack gap={6}>
          <ListActions
            baseUrl={baseUrl}
            currentPage={currentPage}
            filters={filters}
            resetHref={selectedFilters.length > 0 ? resetUrl : undefined}
            showViewToggle
            totalPages={totalPages}
            viewMode={viewParam}
          />

          {viewParam === 'list' && (
            <div class="flex flex-col gap-3 sm:gap-4">
              {paginatedItems.map((post) => (
                <Card list post={post} variant="content" />
              ))}
            </div>
          )}

          {viewParam === 'masonry-2' && (
            <MasonryGrid columns={2}>
              {paginatedItems.map((post) => (
                <div class="masonry-item">
                  <Card post={post} variant="content" />
                </div>
              ))}
            </MasonryGrid>
          )}

          {viewParam === 'masonry-3' && (
            <MasonryGrid columns={3}>
              {paginatedItems.map((post) => (
                <div class="masonry-item">
                  <Card post={post} variant="content" />
                </div>
              ))}
            </MasonryGrid>
          )}
        </Stack>
      ) : (
        <Empty
          action={selectedFilters.length > 0 ? { href: resetUrl, label: 'Clear Filters' } : undefined}
          description={selectedFilters.length > 0 ? `No posts found with ${selectedFilters.length > 1 ? 'these tags' : 'this tag'}.` : "No posts yet."}
          title="No posts found"
        />
      )
    }
  </Section>
</LayoutRoot>

<script>
  import { initInteractiveCards } from '../../lib/interactive-cards';

  initInteractiveCards();
  document.addEventListener('astro:page-load', initInteractiveCards);
</script>
