---
import type { GetStaticPaths } from 'astro';

import { getCollection } from 'astro:content';

import Stack from '../../components/atoms/stack.astro';
import LayoutRoot from '../../components/layout/layout-root.astro';
import ListActions, { type FilterConfig } from '../../components/molecules/list-actions.astro';
import MasonryGrid from '../../components/molecules/masonry-grid.astro';
import Card from '../../components/organisms/card.astro';
import SectionHeader from "../../components/organisms/section-header.astro";
import Section from "../../components/organisms/section.astro";
import { PROFILE } from '../../lib/config';

export const prerender = true;

export const getStaticPaths = (async ({ paginate }) => {
  const allExperience = await getCollection('experience');

  const sortedExperience = [...allExperience].sort((a, b) => {
     return b.data.startDate.valueOf() - a.data.startDate.valueOf();
  });

  // Load ALL items
  return paginate(sortedExperience, { pageSize: 1000 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;

// Client-side defaults
const allSkills = [...new Set(page.data.flatMap(e => e.data.skills || []))].sort();
const INITIAL_PAGE_SIZE = 6; // Default for experience

// Helpers
const getExperienceDate = (data: any) => data.startDate ? new Date(data.startDate).getTime() : 0;

const sortOptions = [
  { href: '?sort=newest', label: 'Newest First', value: 'newest' },
  { href: '?sort=oldest', label: 'Oldest First', value: 'oldest' },
  { href: '?sort=a-z', label: 'A-Z', value: 'a-z' },
];

const skillOptions = [
  { href: '?', label: 'All Skills', value: '' },
  ...allSkills.map(skill => ({
    href: `?filter=${skill}`,
    label: skill,
    value: skill,
  })),
];

const filters: FilterConfig[] = [
  { id: 'sort', label: 'Sort', options: sortOptions, selectedValue: 'newest' },
  ...(allSkills.length > 0 ? [{ id: 'filter', label: 'Skill', options: skillOptions, selectedValue: '' }] : []),
];
---

<LayoutRoot
  description={`${PROFILE.name} - Professional Experience`}
  title={`Experience | ${PROFILE.name}`}
>
  <Section>
    <SectionHeader
      class="mb-8"
      description="My professional journey, key roles, and technical expertise specialized in building scalable systems."
      icon="mdi:briefcase-outline"
      title="Experience"
    />

    <Stack gap={6}>
      <ListActions
        baseUrl="/experience"
        currentPage={1}
        filters={filters}
        itemCountLabel="positions"
        itemsPerPage={INITIAL_PAGE_SIZE}
        paginationType="query"
        showItemCount
        showItemsPerPage={true}
        showViewToggle
        totalItems={page.total}
        totalPages={1}
        viewMode="list"
      />

      <div class="experience-view-list min-h-[50vh]" id="experience-container">

        {/* LIST VIEW (Default) */}
        <div class="list-view flex flex-col gap-3 sm:gap-4 transition-opacity duration-300">
          {page.data.map((exp, index) => (
            <div
              class:list={['list-item transition-all duration-300', { hidden: index >= INITIAL_PAGE_SIZE }]}
              data-date={getExperienceDate(exp.data)}
              data-tags={exp.data.skills?.join(',') || ''}
              data-title={exp.data.company}
            >
              <Card list portfolioItem={{
                desc: exp.data.description,
                href: `/experience/view/${exp.id}/`,
                id: exp.id,
                meta: `${exp.data.startDate.getFullYear()} - ${exp.data.endDate ? exp.data.endDate.getFullYear() : 'Present'} ¬∑ ${exp.data.location}`,
                subtitle: exp.data.role,
                tags: exp.data.skills || [],
                title: exp.data.company,
              }} variant="portfolio" />
            </div>
          ))}
        </div>

        {/* GRID VIEW (Initially Hidden) */}
        <div class="grid-view hidden transition-opacity duration-300">
          <MasonryGrid columns={2}>
            {page.data.map((exp, index) => (
              <div
                class:list={['masonry-item list-item transition-all duration-300', { hidden: index >= INITIAL_PAGE_SIZE }]}
                data-date={getExperienceDate(exp.data)}
                data-tags={exp.data.skills?.join(',') || ''}
                data-title={exp.data.company}
              >
                <Card portfolioItem={{
                  desc: exp.data.description,
                  href: `/experience/view/${exp.id}/`,
                  id: exp.id,
                  meta: `${exp.data.startDate.getFullYear()} - ${exp.data.endDate ? exp.data.endDate.getFullYear() : 'Present'} ¬∑ ${exp.data.location}`,
                  subtitle: exp.data.role,
                  tags: exp.data.skills || [],
                  title: exp.data.company,
                }} variant="portfolio" />
              </div>
            ))}
          </MasonryGrid>
        </div>

        <div class="mt-12 hidden text-center text-gray-500" id="no-results">
           <div class="flex flex-col items-center justify-center gap-2">
             <span class="text-4xl">üîç</span>
             <p class="text-lg font-medium">No experience found.</p>
             <a class="mt-4 rounded-full bg-secondary/10 px-4 py-2 text-sm font-semibold text-secondary transition-colors hover:bg-secondary/20" href="/experience">
                Clear Filters
             </a>
           </div>
        </div>

      </div>
    </Stack>
  </Section>
</LayoutRoot>

<style is:global>
  .hidden { display: none !important; }
</style>

<script>
  import { ClientList } from '../../lib/client-list';
  import { initInteractiveCards } from '../../lib/interactive-cards';

  initInteractiveCards();

  document.addEventListener('astro:page-load', () => {
    initInteractiveCards();

    new ClientList({
      containerId: 'experience-container',
      initialPageSize: 6,
      ui: {
        itemSelector: '.list-item'
      }
    });
  });
</script>
