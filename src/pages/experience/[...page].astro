---
import { getCollection } from 'astro:content';

export const prerender = false;

import Stack from '../../components/atoms/stack.astro';
import LayoutRoot from '../../components/layout/layout-root.astro';
import Empty from '../../components/molecules/empty.astro';
import ListActions, { type FilterConfig, type ViewMode } from '../../components/molecules/list-actions.astro';
import MasonryGrid from '../../components/molecules/masonry-grid.astro';
import Card from '../../components/organisms/card.astro';
import SectionHeader from "../../components/organisms/section-header.astro";
import Section from "../../components/organisms/section.astro";
import { getPagination } from '../../lib/cms';
import { PROFILE } from '../../lib/config';

// Get URL params
const pageParam = Astro.url.searchParams.get('page');
const sortParam = Astro.url.searchParams.get('sort') || 'newest';
const viewParam = (Astro.url.searchParams.get('view') as ViewMode) || 'list';

// Get and process experience
const allExperience = await getCollection('experience');

// Sort experience by date
const sortedExperience = [...allExperience].sort((a, b) => {
  switch (sortParam) {
  case 'a-z':
    return a.data.company.localeCompare(b.data.company);
  case 'z-a':
    return b.data.company.localeCompare(a.data.company);
  case 'newest':
  default:
    return b.data.startDate.valueOf() - a.data.startDate.valueOf();
  }
});

// Get unique skills for filter dropdown
const allSkills = [...new Set(allExperience.flatMap(e => e.data.skills || []))].sort();
const filterParam = Astro.url.searchParams.get('filter');

// Filter experience
const filteredExperience = filterParam
  ? sortedExperience.filter(e => e.data.skills?.includes(filterParam))
  : sortedExperience;

// Pagination
const { currentPage, paginatedItems, totalPages } = getPagination(
  filteredExperience,
  pageParam,
  viewParam === 'list' ? 4 : viewParam === 'grid' ? 4 : 6,
  '/experience',
  Astro.url.searchParams
);

// Helper to build URLs with params
function buildUrl(base: string, params: Record<string, string | undefined>) {
  const url = new URL(base, 'http://localhost');
  Object.entries(params).forEach(([key, value]) => {
    if (value && value !== 'newest') {
      url.searchParams.set(key, value);
    }
  });
  return url.pathname + url.search;
}

// Build filter dropdowns
const sortOptions = [
  { href: buildUrl('/experience', { filter: filterParam || undefined, sort: 'newest' }), label: 'Newest First', value: 'newest' },
  { href: buildUrl('/experience', { filter: filterParam || undefined, sort: 'a-z' }), label: 'A-Z', value: 'a-z' },
  { href: buildUrl('/experience', { filter: filterParam || undefined, sort: 'z-a' }), label: 'Z-A', value: 'z-a' },
];

const skillOptions: { href: string; label: string; value: string; }[] = [
  { href: buildUrl('/experience', { sort: sortParam !== 'newest' ? sortParam : undefined }), label: 'All Skills', value: '' },
  ...allSkills.map(skill => ({
    href: buildUrl('/experience', { filter: skill, sort: sortParam !== 'newest' ? sortParam : undefined }),
    label: skill,
    value: skill,
  })),
];

const filters: FilterConfig[] = [
  {
    id: 'sort',
    label: 'Sort',
    options: sortOptions,
    selectedValue: sortParam,
  },
  ...(allSkills.length > 0 ? [{
    id: 'filter',
    label: 'Skill',
    options: skillOptions,
    selectedValue: filterParam || '',
  }] : []),
];

// Build base URL for pagination
const baseUrl = buildUrl('/experience', { filter: filterParam || undefined, sort: sortParam !== 'newest' ? sortParam : undefined });
---

<LayoutRoot
  description={`${PROFILE.name} - Professional Experience`}
  title={`Experience | ${PROFILE.name}`}
>
  <Section>
    <SectionHeader
      class="mb-8 px-0 sm:px-0 lg:px-0"
      description="My professional journey, key roles, and technical expertise specialized in building scalable systems."
      icon="mdi:briefcase-outline"
      title="Experience"
    />

    {
      paginatedItems.length > 0 ? (
        <Stack gap={6}>
          <ListActions
            baseUrl={baseUrl}
            currentPage={currentPage}
            filters={filters}
            itemCountLabel="positions"
            showItemCount
            showViewToggle
            totalItems={filteredExperience.length}
            totalPages={totalPages}
            viewMode={viewParam}
          />

          {viewParam === 'list' && (
            <div class="flex flex-col gap-3 sm:gap-4">
              {paginatedItems.map((exp) => (
                <Card list portfolioItem={{
                  desc: exp.data.description,
                  href: `/experience/view/${exp.id}/`,
                  id: exp.id,
                  meta: `${exp.data.startDate.getFullYear()} - ${exp.data.endDate ? exp.data.endDate.getFullYear() : 'Present'} \u00b7 ${exp.data.location}`,
                  subtitle: exp.data.role,
                  tags: exp.data.skills || [],
                  title: exp.data.company,
                }} variant="portfolio" />
              ))}
            </div>
          )}

          {viewParam === 'grid' && (
            <MasonryGrid columns={2}>
              {paginatedItems.map((exp) => (
                <div class="masonry-item">
                  <Card portfolioItem={{
                    desc: exp.data.description,
                    href: `/experience/view/${exp.id}/`,
                    id: exp.id,
                    meta: `${exp.data.startDate.getFullYear()} - ${exp.data.endDate ? exp.data.endDate.getFullYear() : 'Present'} \u00b7 ${exp.data.location}`,
                    subtitle: exp.data.role,
                    tags: exp.data.skills || [],
                    title: exp.data.company,
                  }} variant="portfolio" />
                </div>
              ))}
            </MasonryGrid>
          )}

          {viewParam === 'grid' && (
            <MasonryGrid columns={3}>
              {paginatedItems.map((exp) => (
                <div class="masonry-item">
                  <Card portfolioItem={{
                    desc: exp.data.description,
                    href: `/experience/view/${exp.id}/`,
                    id: exp.id,
                    meta: `${exp.data.startDate.getFullYear()} - ${exp.data.endDate ? exp.data.endDate.getFullYear() : 'Present'} \u00b7 ${exp.data.location}`,
                    subtitle: exp.data.role,
                    tags: exp.data.skills || [],
                    title: exp.data.company,
                  }} variant="portfolio" />
                </div>
              ))}
            </MasonryGrid>
          )}
        </Stack>
      ) : (
        <Empty
          action={filterParam ? { href: '/experience', label: 'Clear Filter' } : undefined}
          description={filterParam ? `No experience found with skill "${filterParam}".` : "No experience yet."}
          title="No experience found"
        />
      )
    }
  </Section>
</LayoutRoot>

<script>
  import { initInteractiveCards } from '../../lib/interactive-cards';

  initInteractiveCards();
  document.addEventListener('astro:page-load', initInteractiveCards);
</script>
