---
import type { GetStaticPaths } from 'astro';
import { getCollection } from 'astro:content';
import CollectionPage from '../../../components/templates/collection-page.astro';
import { PROFILE } from '../../../lib/config';

export const prerender = true;

export const getStaticPaths = (async ({ paginate }) => {
  const allExperience = await getCollection('experience');
  const sortedExperience = [...allExperience].sort((a, b) => {
     return b.data.startDate.valueOf() - a.data.startDate.valueOf();
  });
  return paginate(sortedExperience, { pageSize: 1000 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;
const allSkills = [...new Set(page.data.flatMap((e: any) => e.data.skills || []))].sort();

const sortOptions = [
  { href: '?sort=newest', label: 'Newest First', value: 'newest' },
  { href: '?sort=oldest', label: 'Oldest First', value: 'oldest' },
  { href: '?sort=a-z', label: 'A-Z', value: 'a-z' },
];

const skillOptions = [
  { href: '?', label: 'All Skills', value: '' },
  ...allSkills.map(skill => ({
    href: `?filter=${skill}`,
    label: skill,
    value: skill,
  })),
];

const filters = [
  { id: 'sort', label: 'Sort', options: sortOptions, selectedValue: 'newest' },
  ...(allSkills.length > 0 ? [{ id: 'filter', label: 'Skill', options: skillOptions, selectedValue: '' }] : []),
];

// Helpers
const getItemDate = (exp: any) => exp.data.startDate ? new Date(exp.data.startDate).getTime() : 0;
const getItemTags = (exp: any) => exp.data.skills || [];
const getItemCardProps = (exp: any) => ({
  portfolioItem: {
    desc: exp.data.description,
    href: `/experience/view/${exp.id}/`,
    id: exp.id,
    meta: `${exp.data.startDate.getFullYear()} - ${exp.data.endDate ? exp.data.endDate.getFullYear() : 'Present'} Â· ${exp.data.location}`,
    subtitle: exp.data.role,
    tags: exp.data.skills || [],
    title: exp.data.company,
  },
  variant: 'portfolio'
});
---

<CollectionPage
  baseUrl="/experience"
  containerId="experience-container"
  description={`${PROFILE.name} - Professional Experience`}
  filters={filters}
  getItemCardProps={getItemCardProps}
  getItemDate={getItemDate}
  getItemTags={getItemTags}
  headerDescription="My professional journey, key roles, and technical expertise specialized in building scalable systems."
  headerIcon="mdi:briefcase-outline"
  headerTitle="Experience"
  initialPageSize={6}
  items={page.data}
  title={`Experience | ${PROFILE.name}`}
  totalItems={page.total}
  viewMode="grid"
/>
