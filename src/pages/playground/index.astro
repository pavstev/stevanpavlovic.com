---
import { getCollection } from 'astro:content';

import LayoutRoot from '../../components/layout/layout-root.astro';
import Card from '../../components/molecules/card.astro';
import Empty from '../../components/molecules/empty.astro';
import FilterBar from '../../components/molecules/filter-bar.astro';
import MasonryGrid from '../../components/molecules/masonry-grid.astro';
import SectionHeader from "../../components/organisms/section-header.astro";
import Section from "../../components/organisms/section.astro";
import { SITE_TITLE } from '../../consts';
import { filterPosts, getPagination, getUniqueTags, sortPosts } from '../../lib/cms';

const pageParam = Astro.url.searchParams.get('page');
const filterParam = Astro.url.searchParams.get('filter');

const toys = await getCollection('toys');
const tags = getUniqueTags(toys);
const filters = tags.map(tag => ({ label: tag, value: tag }));

let filteredToys = filterPosts(toys, filterParam);
filteredToys = sortPosts(filteredToys, 'newest'); // Playground default sort

const { currentPage, nextUrl, paginatedItems: paginatedToys, prevUrl, totalPages } = getPagination(
  filteredToys,
  pageParam,
  9,
  '/playground',
  Astro.url.searchParams
);
---

<LayoutRoot
  description="Interactive frontend experiments and cool component demos"
  title={`Playground | ${SITE_TITLE}`}
>
  <Section>
    <SectionHeader
      description="A sandbox for UI experiments, code snippets, and interactive components."
      icon="mdi:flask-outline"
      id="playground-heading"
      title="Playground"
    />

    <FilterBar
      activeFilter={filterParam || 'all'}
      baseUrl="/playground"
      filters={filters}
      pagination={{
        currentPage,
        nextUrl,
        prevUrl,
        totalPages
      }}
    />

    {paginatedToys.length > 0 ? (
      <MasonryGrid class="mt-8">
        {
          paginatedToys.map((toy, index) => (
            <div class="masonry-item">
              <Card loading={index === 0 ? 'eager' : 'lazy'} post={toy} variant="content" />
            </div>
          ))
        }
      </MasonryGrid>
    ) : (
      <Empty
        action={
          filterParam
            ? { href: '/playground', label: 'Clear Filter' }
            : undefined
        }
        description={
          filterParam
            ? `No playground items found with tag "${filterParam}".`
            : "The playground is empty right now. Time to build something!"
        }
        icon="mdi:flask-outline"
        title="No experiments found"
      />
    )}
  </Section>
</LayoutRoot>
