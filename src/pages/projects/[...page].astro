---
import { getCollection } from 'astro:content';
import type { Page } from 'astro';

export const prerender = true;

import Stack from '../../components/atoms/stack.astro';
import LayoutRoot from '../../components/layout/layout-root.astro';
import Empty from '../../components/molecules/empty.astro';
import ListActions, { type FilterConfig, type ViewMode } from '../../components/molecules/list-actions.astro';
import MasonryGrid from '../../components/molecules/masonry-grid.astro';
import Card from '../../components/organisms/card.astro';
import SectionHeader from "../../components/organisms/section-header.astro";
import Section from "../../components/organisms/section.astro";
import { PROFILE } from '../../lib/config';

export async function getStaticPaths({ paginate }) {
  const allProjects = await getCollection('projects');
  
  // Sort by newest (default)
  const sortedProjects = [...allProjects].sort((a, b) => {
    const dateA = 'pubDate' in a.data && a.data.pubDate ? (a.data.pubDate as Date).getTime() : 0;
    const dateB = 'pubDate' in b.data && b.data.pubDate ? (b.data.pubDate as Date).getTime() : 0;
    return dateB - dateA;
  });

  return paginate(sortedProjects, { pageSize: 3 });
}

const { page } = Astro.props;
const sortParam = Astro.url.searchParams.get('sort') || 'newest';
const viewParam = (Astro.url.searchParams.get('view') as ViewMode) || 'list';

// Get all tags for filter dropdown (from page.data to avoid extra collection call)
const allTags = [...new Set(page.data.flatMap(p => p.data.tags || []))].sort();
const filterParam = Astro.url.searchParams.get('filter');

// Note: For SSG, filtering is handled via URL params but applied to page.data
const filteredProjects = filterParam
  ? page.data.filter(p => p.data.tags?.includes(filterParam))
  : page.data;

// For SSG with pagination, totalItems should reflect the full collection, not filtered
const totalItems = page.total;

// Helper to build URLs with params
function buildUrl(base: string, params: Record<string, string | undefined>) {
  const url = new URL(base, 'http://localhost');
  Object.entries(params).forEach(([key, value]) => {
    if (value && value !== 'newest') {
      url.searchParams.set(key, value);
    }
  });
  return url.pathname + url.search;
}

// Build filter dropdowns
const sortOptions = [
  { href: buildUrl('/projects', { filter: filterParam || undefined, sort: 'newest' }), label: 'Newest First', value: 'newest' },
  { href: buildUrl('/projects', { filter: filterParam || undefined, sort: 'a-z' }), label: 'A-Z', value: 'a-z' },
  { href: buildUrl('/projects', { filter: filterParam || undefined, sort: 'z-a' }), label: 'Z-A', value: 'z-a' },
];

const tagOptions: { href: string; label: string; value: string; }[] = [
  { href: buildUrl('/projects', { sort: sortParam !== 'newest' ? sortParam : undefined }), label: 'All Tags', value: '' },
  ...allTags.map(tag => ({
    href: buildUrl('/projects', { filter: tag, sort: sortParam !== 'newest' ? sortParam : undefined }),
    label: tag.charAt(0).toUpperCase() + tag.slice(1),
    value: tag,
  })),
];

const filters: FilterConfig[] = [
  {
    id: 'sort',
    label: 'Sort',
    options: sortOptions,
    selectedValue: sortParam,
  },
  ...(allTags.length > 0 ? [{
    id: 'filter',
    label: 'Tag',
    options: tagOptions,
    selectedValue: filterParam || '',
  }] : []),
];

// Build base URL for pagination
const baseUrl = buildUrl('/projects', { filter: filterParam || undefined, sort: sortParam !== 'newest' ? sortParam : undefined });
---

<LayoutRoot
  description={`${PROFILE.name} - Projects & Portfolio`}
  title={`Projects | ${PROFILE.name}`}
>
  <Section>
    <SectionHeader
      class="mb-8 px-0 sm:px-0 lg:px-0"
      description="A collection of open-source libraries, applications, and experiments I've built."
      icon="mdi:console"
      title="Projects"
    />

    {
      filteredProjects.length > 0 ? (
        <Stack gap={6}>
          <ListActions
            baseUrl={baseUrl}
            currentPage={page.currentPage}
            filters={filters}
            itemCountLabel="projects"
            showItemCount
            showViewToggle
            totalItems={totalItems}
            totalPages={page.lastPage}
            viewMode={viewParam}
          />

          {viewParam === 'list' && (
            <div class="flex flex-col gap-3 sm:gap-4">
              {filteredProjects.map((project) => (
                <Card list portfolioItem={{
                  desc: project.data.desc,
                  href: `/projects/${project.id}/`,
                  id: project.id,
                  meta: project.data.meta,
                  subtitle: project.data.subtitle,
                  tags: project.data.tags,
                  title: project.data.title,
                }} variant="portfolio" />
              ))}
            </div>
          )}

          {viewParam === 'masonry-2' && (
            <MasonryGrid columns={2}>
              {filteredProjects.map((project) => (
                <div class="masonry-item">
                  <Card portfolioItem={{
                    desc: project.data.desc,
                    href: `/projects/${project.id}/`,
                    id: project.id,
                    meta: project.data.meta,
                    subtitle: project.data.subtitle,
                    tags: project.data.tags,
                    title: project.data.title,
                  }} variant="portfolio" />
                </div>
              ))}
            </MasonryGrid>
          )}

          {viewParam === 'masonry-3' && (
            <MasonryGrid columns={3}>
              {filteredProjects.map((project) => (
                <div class="masonry-item">
                  <Card portfolioItem={{
                    desc: project.data.desc,
                    href: `/projects/${project.id}/`,
                    id: project.id,
                    meta: project.data.meta,
                    subtitle: project.data.subtitle,
                    tags: project.data.tags,
                    title: project.data.title,
                  }} variant="portfolio" />
                </div>
              ))}
            </MasonryGrid>
          )}
        </Stack>
      ) : (
        <Empty
          action={filterParam ? { href: '/projects', label: 'Clear Filter' } : undefined}
          description={filterParam ? `No projects found with tag "${filterParam}".` : "No projects yet."}
          title="No projects found"
        />
      )
    }
  </Section>
</LayoutRoot>

<script>
  import { initInteractiveCards } from '../../lib/interactive-cards';

  initInteractiveCards();
  document.addEventListener('astro:page-load', initInteractiveCards);
</script>
