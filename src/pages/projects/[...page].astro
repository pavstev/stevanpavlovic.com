---
import type { GetStaticPaths } from 'astro';

import { getCollection } from 'astro:content';

import Stack from '../../components/atoms/stack.astro';
import LayoutRoot from '../../components/layout/layout-root.astro';
import ListActions, { type FilterConfig } from '../../components/molecules/list-actions.astro';
import MasonryGrid from '../../components/molecules/masonry-grid.astro';
import Card from '../../components/organisms/card.astro';
import SectionHeader from "../../components/organisms/section-header.astro";
import Section from "../../components/organisms/section.astro";
import { PROFILE } from '../../lib/config';

export const prerender = true;

export const getStaticPaths = (async ({ paginate }) => {
  const allProjects = await getCollection('projects');

  const sortedProjects = [...allProjects].sort((a, b) => {
    const dateA = 'pubDate' in a.data && a.data.pubDate ? (a.data.pubDate as Date).getTime() : 0;
    const dateB = 'pubDate' in b.data && b.data.pubDate ? (b.data.pubDate as Date).getTime() : 0;
    return dateB - dateA;
  });

  // We load ALL projects into one static page (effectively) to allow
  // dynamic client-side pagination and "items per page" handling.
  return paginate(sortedProjects, { pageSize: 1000 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;

// --- Client-Side State Helpers ---
// In SSG, we use the URL search params (available via Astro.url only for initial build hint)
// But real values come from client. We set defaults here for the initial render.
// Note: Astro.url.searchParams is empty during build, so defaults apply.
const allTags = [...new Set(page.data.flatMap(p => p.data.tags || []))].sort();

// Logic Helpers
const getProjectDate = (data: any) => data.pubDate ? new Date(data.pubDate).getTime() : 0;
const INITIAL_PAGE_SIZE = 6;

const sortOptions = [
  { href: '?sort=newest', label: 'Newest First', value: 'newest' },
  { href: '?sort=a-z', label: 'A-Z', value: 'a-z' },
];

const tagOptions = [
  { href: '?', label: 'All Tags', value: '' },
  ...allTags.map(tag => ({
    href: `?filter=${tag}`,
    label: tag.charAt(0).toUpperCase() + tag.slice(1),
    value: tag,
  })),
];

const filters: FilterConfig[] = [
  { id: 'sort', label: 'Sort', options: sortOptions, selectedValue: 'newest' },
  ...(allTags.length > 0 ? [{ id: 'filter', label: 'Tag', options: tagOptions, selectedValue: '' }] : []),
];
---

<LayoutRoot
  description={`${PROFILE.name} - Projects & Portfolio`}
  title={`Projects | ${PROFILE.name}`}
>
  <Section>
    <SectionHeader
      class="mb-8"
      description="A collection of open-source libraries, applications, and experiments I've built."
      icon="mdi:console"
      title="Projects"
    />

    <Stack gap={6}>
      {/* ListActions now acts as a Client-Side Controller.
        We pass default values, but the script below will update the UI based on URL params.
      */}
      <ListActions
        baseUrl="/projects"
        currentPage={1}
        filters={filters}
        itemCountLabel="projects"
        itemsPerPage={INITIAL_PAGE_SIZE}
        paginationType="query"
        showItemCount
        showItemsPerPage={true}
        showViewToggle
        totalItems={page.total}
        totalPages={1}
        viewMode="list"
      />

      <div class="project-view-list min-h-[50vh]" id="projects-container">

        {/* LIST VIEW */}
        <div class="list-view flex flex-col gap-4 transition-opacity duration-300">
          {page.data.map((project, index) => (
            <div
              class:list={['project-item transition-all duration-300', { hidden: index >= INITIAL_PAGE_SIZE }]}
              data-date={getProjectDate(project.data)}
              data-tags={project.data.tags?.join(',') || ''}
              data-title={project.data.title}
            >
              <Card list portfolioItem={{
                desc: project.data.desc,
                href: `/projects/view/${project.id}/`,
                id: project.id,
                meta: project.data.meta,
                subtitle: project.data.subtitle,
                tags: project.data.tags,
                title: project.data.title,
              }} variant="portfolio" />
            </div>
          ))}
        </div>

        {/* GRID VIEW */}
        <div class="grid-view hidden transition-opacity duration-300">
          <MasonryGrid columns={2}>
            {page.data.map((project, index) => (
              <div
                class:list={['masonry-item project-item transition-all duration-300', { hidden: index >= INITIAL_PAGE_SIZE }]}
                data-date={getProjectDate(project.data)}
                data-tags={project.data.tags?.join(',') || ''}
                data-title={project.data.title}
              >
                <Card portfolioItem={{
                  desc: project.data.desc,
                  href: `/projects/view/${project.id}/`,
                  id: project.id,
                  meta: project.data.meta,
                  subtitle: project.data.subtitle,
                  tags: project.data.tags,
                  title: project.data.title,
                }} variant="portfolio" />
              </div>
            ))}
          </MasonryGrid>
        </div>

        <div class="mt-12 hidden text-center text-gray-500" id="no-results">
          <div class="flex flex-col items-center justify-center gap-2">
            <span class="text-4xl">üîç</span>
            <p class="text-lg font-medium">No projects found.</p>
            <a class="mt-4 rounded-full bg-secondary/10 px-4 py-2 text-sm font-semibold text-secondary transition-colors hover:bg-secondary/20" href="/projects">
               Clear Filters
            </a>
          </div>
        </div>

      </div>
    </Stack>
  </Section>
</LayoutRoot>

<style is:global>
  /* Global hidden class to ensure it overrides specific styles */
  .hidden { display: none !important; }
</style>

<script>
  import { ClientList } from '../../lib/client-list';
  import { initInteractiveCards } from '../../lib/interactive-cards';

  // Initialize on first load
  initInteractiveCards();

  document.addEventListener('astro:page-load', () => {
    initInteractiveCards();

    new ClientList({
      containerId: 'projects-container',
      initialPageSize: 6,
      ui: {
        itemSelector: '.project-item'
      }
    });
  });
</script>
