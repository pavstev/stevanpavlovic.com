---
import type { GetStaticPaths } from 'astro';
import { getCollection } from 'astro:content';
import CollectionPage from '../../../components/templates/collection-page.astro';
import { PROFILE } from '../../../lib/config';

export const prerender = true;

export const getStaticPaths = (async ({ paginate }) => {
  const allProjects = await getCollection('projects');
  const sortedProjects = [...allProjects].sort((a, b) => {
    const dateA = 'pubDate' in a.data && a.data.pubDate ? (a.data.pubDate as Date).getTime() : 0;
    const dateB = 'pubDate' in b.data && b.data.pubDate ? (b.data.pubDate as Date).getTime() : 0;
    return dateB - dateA;
  });
  return paginate(sortedProjects, { pageSize: 1000 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;
const allTags = [...new Set(page.data.flatMap((p: any) => p.data.tags || []))].sort();

const sortOptions = [
  { href: '?sort=newest', label: 'Newest First', value: 'newest' },
  { href: '?sort=a-z', label: 'A-Z', value: 'a-z' },
];

const tagOptions = [
  { href: '?', label: 'All Tags', value: '' },
  ...allTags.map((tag: string) => ({
    href: `?filter=${tag}`,
    label: tag.charAt(0).toUpperCase() + tag.slice(1),
    value: tag,
  })),
];

const filters = [
  { id: 'sort', label: 'Sort', options: sortOptions, selectedValue: 'newest' },
  ...(allTags.length > 0 ? [{ id: 'filter', label: 'Tag', options: tagOptions, selectedValue: '' }] : []),
];

// Helpers
const getItemDate = (project: any) => project.data.pubDate ? new Date(project.data.pubDate).getTime() : 0;
const getItemTags = (project: any) => project.data.tags || [];
const getItemCardProps = (project: any) => ({
  portfolioItem: {
    desc: project.data.desc,
    href: `/projects/view/${project.id}/`,
    id: project.id,
    meta: project.data.meta,
    subtitle: project.data.subtitle,
    tags: project.data.tags,
    title: project.data.title,
  },
  variant: 'portfolio'
});
---

<CollectionPage
  baseUrl="/projects"
  containerId="projects-container"
  description={`${PROFILE.name} - Projects & Portfolio`}
  filters={filters}
  getItemCardProps={getItemCardProps}
  getItemDate={getItemDate}
  getItemTags={getItemTags}
  headerDescription="A collection of open-source libraries, applications, and experiments I've built."
  headerIcon="mdi:console"
  headerTitle="Projects"
  initialPageSize={6}
  items={page.data}
  title={`Projects | ${PROFILE.name}`}
  totalItems={page.total}
  viewMode="grid"
/>
