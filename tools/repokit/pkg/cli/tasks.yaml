# yaml-language-server: $schema=../../../eslint/schemas/tasks.schema.json
vars:
  root_dir: .
  rk_dir: tools/repokit
  rk_bin: tools/repokit/dist/repokit
  pnpm: pnpm exec
  go: go

tasks:
  # --- Atomic Tasks ---
  lint_eslint:
    name: ESLint
    type: single
    pre_msg: Analyzing frontend code quality...
    on_error: ESLint found issues in the codebase.
    command: ${pnpm} eslint . --fix --cache --max-warnings=0

  knip:
    name: Knip
    type: single
    pre_msg: Checking for unused files and dependencies...
    on_error: Knip found unused code, exports, or dependencies.
    command: ${pnpm} knip -c knip.config.ts

  format_prettier:
    name: Prettier Format
    type: single
    pre_msg: Formatting codebase with Prettier...
    on_error: Prettier failed to format files.
    command: ${pnpm} prettier --write --cache .

  build_go:
    name: Go Build
    type: single
    pre_msg: Compiling Repokit orchestrator...
    on_error: Failed to build Go binary.
    command: ${go} build -o ../../${rk_bin} ./main.go > /dev/null
    cwd: ${rk_dir}

  check_astro:
    name: Astro Check
    type: single
    pre_msg: Checking Astro files...
    on_error: Failed to perform Astro check.
    command: ${pnpm} astro check
    cwd: ${rk_dir}

  check_go:
    name: Astro Check
    type: single
    pre_msg: Checking Astro files...
    on_error: Failed to perform Astro check.
    command: ${go} vet ./...
    cwd: ${rk_dir}

  # --- Schema ---
  format_schema:
    name: Format Schema
    type: single
    pre_msg: Formatting schemas...
    on_error: Failed to format the json schemas.
    command: ${pnpm} prettier tools/eslint/schemas/**/*.schema.json -w --cache

  generate_schema:
    name: Schema Generation Pipeline
    type: batch
    pre_msg: Starting the generation...
    on_error: One or more linters failed.
    tasks: [export_schema, format_schema]
    parallel: false

  # --- Unified Batch Pipelines ---
  lint:
    name: Linting Pipeline
    type: batch
    pre_msg: Starting full project linting pass...
    on_error: One or more linters failed.
    tasks: [lint_eslint, knip]
    parallel: true

  test:
    name: Test Pipeline
    type: batch
    pre_msg: Running project tests...
    on_error: One or more tests failed.
    tasks: []
    parallel: true

  format:
    name: Format Pipeline
    type: batch
    pre_msg: Running code formatters...
    on_error: Formatting failed.
    tasks: [format_prettier]
    parallel: true

  check:
    name: Check Pipeline
    type: batch
    pre_msg: Running all code quality checks...
    on_error: Checks failed.
    tasks: [check_astro]
    parallel: false

  build:
    name: Build Pipeline
    type: batch
    pre_msg: Building full project...
    on_error: Build failed.
    tasks: [build_go]
    parallel: true

  setup:
    name: Project Setup
    type: batch
    pre_msg: Orchestrating hybrid environment setup...
    on_error: Environment setup failed.
    tasks: [build_go]
    parallel: false

  all:
    name: All Tasks Pipeline
    type: batch
    pre_msg: Running complete project pipeline...
    on_error: One or more pipelines failed.
    tasks: [generate_schema, format, lint, check, build, test, knip]
    parallel: false
