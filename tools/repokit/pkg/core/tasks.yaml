# yaml-language-server: $schema=../../../eslint/schemas/tasks.schema.json
vars:
  root_dir: .
  rk_dir: tools/repokit
  rk_bin: tools/repokit/dist/repokit
  pnpm: pnpm exec
  go: go

tasks:
  # --- Atomic Tasks ---
  lint_eslint:
    name: ESLint
    type: single
    pre_msg: Analyzing frontend code quality...
    on_error: ESLint found code quality issues.
    command: ${pnpm} eslint . --fix --cache --max-warnings=0

  knip:
    name: Knip
    type: single
    pre_msg: Scanning for unused dependencies and exports...
    on_error: Knip detected unused code or dependencies.
    command: ${pnpm} knip -c knip.config.ts

  format_prettier:
    name: Prettier
    type: single
    pre_msg: Enforcing code formatting rules...
    on_error: Prettier formatting failed.
    command: ${pnpm} prettier --write --cache .

  build_go:
    name: Build Go Binary
    type: single
    pre_msg: Compiling the Repokit orchestrator...
    on_error: Failed to compile the Repokit binary.
    command: ${pnpm} go-build

  check_astro:
    name: Typecheck Astro
    type: single
    pre_msg: Performing Astro type checking...
    on_error: Astro type checking failed.
    command: ${pnpm} astro check
    cwd: ${rk_dir}

  check_go:
    name: Typecheck Go
    type: single
    pre_msg: Analyzing Go packages for static errors...
    on_error: Go vet detected static errors.
    command: ${go} vet ./...
    cwd: ${rk_dir}

  test_go:
    name: Run Go Tests
    type: single
    pre_msg: Executing the Go test suite...
    on_error: One or more Go tests failed.
    command: ${go} test ./... -v
    cwd: ${rk_dir}

  test_go_cov:
    name: Run Go Tests with Coverage
    type: single
    pre_msg: Executing tests and generating coverage report...
    on_error: Coverage analysis failed.
    command: ${go} test -v -coverprofile=coverage.out -json ./pkg/... | tparse -all -top && ${go} tool cover -html=coverage.out -o coverage.html
    cwd: ${rk_dir}

  optimize_svg:
    name: Optimize SVGs
    type: single
    pre_msg: Minifying and optimizing SVG assets...
    on_error: Failed to optimize SVGs.
    command: ${rk_bin} optimize-svg src/assets/**/*.svg

  # --- Schema ---
  format_schema:
    name: Format Schema
    type: single
    pre_msg: Formatting generated JSON schema files...
    on_error: Schema formatting failed.
    command: ${pnpm} prettier tools/eslint/schemas/**/*.schema.json -w --cache

  generate_schema:
    name: Generate Schema Pipeline
    type: batch
    pre_msg: Synchronizing configuration schemas...
    on_error: Failed to securely synchronize schemas.
    tasks: [export_schema, format_schema]
    parallel: false

  # --- Unified Batch Pipelines ---
  lint:
    name: Linting Pipeline
    type: batch
    pre_msg: Executing the global linting pipeline...
    on_error: The linting pipeline encountered errors.
    tasks: [lint_eslint, knip, optimize_svg]
    parallel: true

  test:
    name: Testing Pipeline
    type: batch
    pre_msg: Executing the universal testing pipeline...
    on_error: One or more test suites failed.
    tasks: [test_go]
    parallel: true

  format:
    name: Formatting Pipeline
    type: batch
    pre_msg: Executing the global formatting pipeline...
    on_error: The formatting pipeline failed.
    tasks: [format_prettier]
    parallel: true

  check:
    name: Typecheck Pipeline
    type: batch
    pre_msg: Executing the static analysis pipeline...
    on_error: The typechecking pipeline detected errors.
    tasks: [check_astro]
    parallel: false

  build:
    name: Build Pipeline
    type: batch
    pre_msg: Executing the core build pipeline...
    on_error: The build pipeline failed to produce artifacts.
    tasks: [build_go]
    parallel: true

  cf_deploy:
    name: Deploy
    type: single
    pre_msg: Shipping the deployment to Cloudflare...
    on_error: Deployment rejected by the Cloudflare edge.
    command: ${pnpm} wrangler deploy

  cf_dev:
    name: Development Server
    type: single
    pre_msg: Booting the local Cloudflare dev runtime...
    on_error: The development server crashed.
    command: ${pnpm} wrangler dev

  cf_types:
    name: Cloudflare Types
    type: single
    pre_msg: Abstracting Cloudflare binding interfaces...
    on_error: Failed to generate interface typings.
    command: ${pnpm} wrangler types

  ls-files:
    name: List Files
    type: single
    pre_msg: Listing project files...
    on_error: Failed to list files.
    command: git ls-files --exclude-standard -co | tree --fromfile .

  export_schema:
    name: Export JSON Schema
    type: single
    pre_msg: Exporting configuration constraints...
    on_error: Constraint export failed.
    command: ${rk_bin} export_schema

  setup:
    name: Initialize Project
    type: batch
    pre_msg: Bootstrapping the local development environment...
    on_error: Development setup aborted.
    tasks: [build, generate_schema]
    parallel: false

  all:
    name: Universal Pipeline
    type: batch
    pre_msg: Commencing full project verification...
    on_error: The universal pipeline failed.
    tasks:
      - build_go
      - export_schema
      - format_schema
      - format_prettier
      - lint_eslint
      - knip
      - optimize_svg
      - check_astro
      - check_go
      - test_go
      - cf_types
    parallel: false
